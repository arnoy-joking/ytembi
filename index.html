<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniPlayer Pro: Bulletproof Edition</title>
    <style>
        :root {
            --primary: #ff0033;
            --bg: #050505;
            --surface: #111114;
            --text: #ffffff;
            --text-dim: #707080;
            --border: #222228;
            --radius: 12px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; background: var(--bg); color: var(--text); 
            font-family: 'Inter', system-ui, sans-serif; height: 100vh; overflow: hidden; 
        }

        .app-container {
            display: grid;
            grid-template-columns: 1fr 340px;
            grid-template-rows: 60px 1fr;
            height: 100%;
        }

        header {
            grid-column: 1 / -1;
            background: #000;
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 100;
        }

        .logo { font-weight: 900; color: var(--primary); letter-spacing: -1px; }

        /* Stage */
        .stage {
            grid-column: 1; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            overflow-y: auto; position: relative;
        }

        .video-wrapper {
            width: 100%; max-width: 1000px;
            aspect-ratio: 16/9; background: #000;
            border-radius: var(--radius); position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            overflow: hidden;
        }

        #player { width: 100%; height: 100%; pointer-events: auto; }

        /* The Ultimate Blocker */
        .strict-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9999; display: none; background: rgba(0,0,0,0);
        }
        body.live-active .strict-overlay { display: block; cursor: lock; }

        .live-banner {
            position: absolute; top: 15px; left: 15px; z-index: 10000;
            background: var(--primary); color: white; padding: 6px 12px;
            border-radius: 4px; font-weight: bold; font-size: 12px;
            display: none; animation: flash 1.5s infinite;
        }
        body.live-active .live-banner { display: block; }
        @keyframes flash { 50% { opacity: 0.5; } }

        .focus-warning {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,0,51,0.9); z-index: 20000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; backdrop-filter: blur(10px);
        }

        /* Controls */
        .ui-panel {
            width: 100%; max-width: 600px; margin-top: 25px;
            transition: 0.3s;
        }
        body.live-active .ui-panel { opacity: 0; pointer-events: none; }

        .input-row { display: flex; gap: 10px; }
        input {
            flex: 1; background: var(--surface); border: 1px solid var(--border);
            color: white; padding: 12px; border-radius: 8px;
        }
        button {
            background: var(--primary); color: white; border: none;
            padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer;
        }
        button:disabled { background: #333; cursor: not-allowed; }

        /* Sidebar */
        .sidebar {
            background: var(--surface); border-left: 1px solid var(--border);
            display: flex; flex-direction: column; transition: 0.3s;
        }
        body.live-active .sidebar { filter: blur(5px); pointer-events: none; opacity: 0.5; }

        .hist-item {
            padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer;
            display: flex; gap: 10px; font-size: 13px;
        }
        .hist-item:hover { background: #1a1a1f; }
        .hist-thumb { width: 80px; height: 45px; background: #000; border-radius: 4px; flex-shrink: 0; }

        .toast {
            position: fixed; bottom: 20px; left: 20px; background: white;
            color: black; padding: 10px 20px; border-radius: 5px;
            font-weight: bold; z-index: 100000; display: none;
        }
    </style>
</head>
<body oncontextmenu="return false;">

<div class="focus-warning" id="focusWarning">
    <h1>FOCUS LOST!</h1>
    <p>Live class is paused. Return to this tab to continue.</p>
</div>

<div class="app-container">
    <header>
        <div class="logo">OMNIPLAYER PRO</div>
        <div>
            <button id="liveBtn" style="background: #222;">Enter Live Mode</button>
        </div>
    </header>

    <div class="stage">
        <div class="video-wrapper">
            <div class="live-banner" id="liveBanner">STRICT LIVE MODE ACTIVE</div>
            <div class="strict-overlay" id="blocker"></div>
            <div id="player"></div>
        </div>

        <div class="ui-panel">
            <div class="input-row">
                <input type="text" id="urlInput" placeholder="Enter YouTube URL...">
                <button id="loadBtn">LOAD</button>
            </div>
            <p id="status" style="color: var(--text-dim); font-size: 12px; margin-top: 10px;">Waiting...</p>
        </div>
    </div>

    <aside class="sidebar">
        <div style="padding: 20px; border-bottom: 1px solid var(--border); font-weight: bold;">HISTORY</div>
        <div id="historyList" style="overflow-y: auto; flex: 1;"></div>
    </aside>
</div>

<div id="toast" class="toast"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
    /**
     * OmniPlayer Pro - "Bulletproof" Logic
     * বাংলা ব্যাখ্যা: 
     * ১. হার্টবিট সেভ (১ সেকেন্ড অন্তর)
     * ২. ট্যাব ফোকাস চেক (অন্য ট্যাবে গেলে পজ হবে)
     * ৩. কিবোর্ড এবং মাউস হার্ড-লক
     */

    let player;
    let currentId = null;
    let saveInterval;
    
    // DB Structure
    let db = JSON.parse(localStorage.getItem('omni_v8_db')) || {
        history: {},
        activeLiveId: null,
        isLive: false
    };

    function saveDb() { localStorage.setItem('omni_v8_db', JSON.stringify(db)); }

    function onYouTubeIframeAPIReady() {
        if (db.isLive && db.activeLiveId) {
            currentId = db.activeLiveId;
            startLiveSession(currentId);
        }
    }

    function initPlayer(id, isLiveMode = false) {
        if (player) player.destroy();
        currentId = id;
        
        const startTime = (db.history[id]?.time || 0);

        player = new YT.Player('player', {
            videoId: id,
            playerVars: {
                autoplay: 1,
                controls: isLiveMode ? 0 : 1,
                disablekb: isLiveMode ? 1 : 0,
                modestbranding: 1,
                rel: 0,
                start: Math.floor(startTime)
            },
            events: {
                'onReady': (e) => {
                    e.target.playVideo();
                    if (isLiveMode) document.body.classList.add('live-active');
                },
                'onStateChange': onPlayerStateChange
            }
        });
        renderHistory();
    }

    function onPlayerStateChange(event) {
        if (event.data === YT.PlayerState.PLAYING) {
            startHeartbeat();
        } else {
            stopHeartbeat();
        }

        // Auto-Unlock when finished
        if (event.data === YT.PlayerState.ENDED && db.isLive) {
            unlockLiveMode();
        }
    }

    function startHeartbeat() {
        clearInterval(saveInterval);
        saveInterval = setInterval(() => {
            if (player && player.getCurrentTime) {
                const time = player.getCurrentTime();
                const dur = player.getDuration();
                if (time > 0) {
                    db.history[currentId] = { time, dur, thumb: `https://img.youtube.com/vi/${currentId}/default.jpg` };
                    saveDb();
                }
            }
        }, 1000); // 1-second heartbeat
    }

    function stopHeartbeat() { clearInterval(saveInterval); }

    function startLiveSession(id) {
        db.isLive = true;
        db.activeLiveId = id;
        saveDb();
        initPlayer(id, true);
        showToast("LIVE MODE: ON");
    }

    function unlockLiveMode() {
        db.isLive = false;
        db.activeLiveId = null;
        saveDb();
        document.body.classList.remove('live-active');
        showToast("Class Complete! Unlocked.");
        initPlayer(currentId, false); // Reload with controls
    }

    // Anti-Cheat: Tab Focus Logic
    window.addEventListener('blur', () => {
        if (db.isLive && player && player.pauseVideo) {
            player.pauseVideo();
            document.getElementById('focusWarning').style.display = 'flex';
        }
    });

    window.addEventListener('focus', () => {
        document.getElementById('focusWarning').style.display = 'none';
        if (db.isLive && player && player.playVideo) {
            player.playVideo();
        }
    });

    // Keyboard Lock
    window.addEventListener('keydown', (e) => {
        if (db.isLive) {
            const forbidden = [' ', 'ArrowLeft', 'ArrowRight', 'j', 'k', 'l', 'f', 'm'];
            if (forbidden.includes(e.key.toLowerCase())) {
                e.preventDefault();
                showToast("Action Blocked in Live Mode");
            }
        }
    }, true);

    // Prevent closing tab
    window.onbeforeunload = function() {
        if (db.isLive) return "You are in a live class! Progress will be saved, but you must finish it.";
    };

    // UI Listeners
    document.getElementById('loadBtn').onclick = () => {
        const val = document.getElementById('urlInput').value;
        const id = val.includes('v=') ? val.split('v=')[1].split('&')[0] : (val.length === 11 ? val : null);
        if (id) initPlayer(id);
        else alert("Invalid ID");
    };

    document.getElementById('liveBtn').onclick = () => {
        if (!currentId) return alert("Load a video first");
        if (confirm("START LIVE CLASS?\n- No seeking\n- No skipping\n- Pauses if you switch tabs")) {
            startLiveSession(currentId);
        }
    };

    function renderHistory() {
        const list = document.getElementById('historyList');
        list.innerHTML = '';
        for (let id in db.history) {
            const item = db.history[id];
            const div = document.createElement('div');
            div.className = 'hist-item';
            div.innerHTML = `
                <img src="${item.thumb}" class="hist-thumb">
                <div>
                    <b>${id}</b><br>
                    <small>${Math.floor(item.time)} / ${Math.floor(item.dur)}s</small>
                </div>
            `;
            div.onclick = () => !db.isLive && initPlayer(id);
            list.appendChild(div);
        }
    }

    function showToast(m) {
        const t = document.getElementById('toast');
        t.innerText = m;
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 3000);
    }

    renderHistory();
</script>
</body>
</html>
