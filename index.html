<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniPlayer Pro: Bulletproof Edition</title>
    <style>
        :root {
            --primary: #ff0033;
            --bg: #050505;
            --surface: #111114;
            --text: #ffffff;
            --text-dim: #707080;
            --border: #222228;
            --radius: 12px;
            --sidebar-width: 340px;
            --header-height: 60px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; background: var(--bg); color: var(--text); 
            font-family: 'Inter', system-ui, sans-serif; height: 100vh; overflow: hidden; 
        }

        /* Responsive Grid with Theater Logic */
        .app-container {
            display: grid;
            grid-template-columns: 1fr var(--sidebar-width);
            grid-template-rows: var(--header-height) 1fr;
            height: 100%;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.live-active .app-container {
            grid-template-columns: 1fr 0px;
            grid-template-rows: 0px 1fr;
        }

        header {
            grid-column: 1 / -1;
            background: #000;
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 100;
            overflow: hidden;
        }

        .logo { font-weight: 900; color: var(--primary); letter-spacing: -1px; }

        /* Stage / Theater Mode */
        .stage {
            grid-column: 1; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            overflow-y: auto; position: relative;
            transition: padding 0.5s ease;
        }

        body.live-active .stage {
            padding: 0;
            justify-content: center;
            background: #000;
        }

        .video-wrapper {
            width: 100%; max-width: 1000px;
            aspect-ratio: 16/9; background: #000;
            border-radius: var(--radius); position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            overflow: hidden;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.live-active .video-wrapper {
            max-width: 100vw;
            width: 100vw;
            height: 100vh;
            border-radius: 0;
            box-shadow: none;
        }

        #player { width: 100%; height: 100%; }

        /* The Ultimate Blocker */
        .strict-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9999; display: none; background: rgba(0,0,0,0);
        }
        body.live-active .strict-overlay { display: block; }

        .live-banner {
            position: absolute; top: 20px; left: 20px; z-index: 10000;
            background: var(--primary); color: white; padding: 8px 16px;
            border-radius: 4px; font-weight: bold; font-size: 14px;
            display: none; animation: flash 2s infinite;
            box-shadow: 0 4px 15px rgba(255,0,51,0.4);
        }
        body.live-active .live-banner { display: block; }
        @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        .focus-warning {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 20000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; backdrop-filter: blur(15px);
            color: var(--primary);
        }

        /* Controls */
        .ui-panel {
            width: 100%; max-width: 600px; margin-top: 25px;
            transition: opacity 0.3s;
        }
        body.live-active .ui-panel { opacity: 0; pointer-events: none; position: absolute; }

        .input-row { display: flex; gap: 10px; }
        input {
            flex: 1; background: var(--surface); border: 1px solid var(--border);
            color: white; padding: 12px; border-radius: 8px; outline: none;
        }
        input:focus { border-color: var(--primary); }
        button {
            background: var(--primary); color: white; border: none;
            padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.95); }

        /* Sidebar */
        .sidebar {
            background: var(--surface); border-left: 1px solid var(--border);
            display: flex; flex-direction: column; 
            overflow: hidden;
        }

        .hist-item {
            padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer;
            display: flex; gap: 10px; font-size: 13px; transition: 0.2s;
        }
        .hist-item:hover { background: #1a1a1f; }
        .hist-thumb { width: 100px; height: 56px; background: #000; border-radius: 4px; flex-shrink: 0; object-fit: cover; }

        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: var(--primary); color: white; padding: 12px 24px; border-radius: 30px;
            font-weight: bold; z-index: 100000; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body oncontextmenu="return false;">

<div class="focus-warning" id="focusWarning">
    <h1 style="font-size: 3rem;">ATTENTION REQUIRED</h1>
    <p>Video paused. Please return to the tab to continue your class.</p>
</div>

<div class="app-container" id="mainContainer">
    <header>
        <div class="logo">OMNIPLAYER PRO</div>
        <div>
            <button id="liveBtn" style="background: #222;">Enter Theater Live Mode</button>
        </div>
    </header>

    <div class="stage">
        <div class="video-wrapper">
            <div class="live-banner" id="liveBanner">‚óè LIVE THEATER MODE</div>
            <div class="strict-overlay" id="blocker"></div>
            <div id="player"></div>
        </div>

        <div class="ui-panel">
            <div class="input-row">
                <input type="text" id="urlInput" placeholder="Paste YouTube link here...">
                <button id="loadBtn">LOAD VIDEO</button>
            </div>
            <p id="status" style="color: var(--text-dim); font-size: 12px; margin-top: 10px; text-align: center;">Your progress is synced automatically.</p>
        </div>
    </div>

    <aside class="sidebar">
        <div style="padding: 20px; border-bottom: 1px solid var(--border); font-weight: bold; letter-spacing: 1px;">MY LIBRARY</div>
        <div id="historyList" style="overflow-y: auto; flex: 1;"></div>
    </aside>
</div>

<div id="toast" class="toast"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
    /**
     * OMNIPLAYER PRO - THEATER PERSISTENCE UPDATE
     * 1. Auto-loads previous session on refresh.
     * 2. Theater Mode expands video to 100vw/100vh.
     * 3. Aggressive focus detection.
     */

    let player;
    let currentId = null;
    let saveInterval;
    
    // Load state from Storage immediately
    let db = JSON.parse(localStorage.getItem('omni_pro_v9')) || {
        history: {},
        activeLiveId: null,
        isLive: false,
        lastWatchedId: null
    };

    function saveDb() { localStorage.setItem('omni_pro_v9', JSON.stringify(db)); }

    // YouTube API Ready
    function onYouTubeIframeAPIReady() {
        console.log("YouTube API Ready");
        // If user refreshed while in live mode or had a video open
        if (db.isLive && db.activeLiveId) {
            initPlayer(db.activeLiveId, true);
        } else if (db.lastWatchedId) {
            initPlayer(db.lastWatchedId, false);
        }
    }

    function initPlayer(id, isLiveMode = false) {
        if (player && player.destroy) player.destroy();
        
        currentId = id;
        db.lastWatchedId = id;
        saveDb();
        
        const startTime = (db.history[id]?.time || 0);

        player = new YT.Player('player', {
            videoId: id,
            playerVars: {
                autoplay: 1,
                controls: isLiveMode ? 0 : 1,
                disablekb: isLiveMode ? 1 : 0,
                modestbranding: 1,
                rel: 0,
                showinfo: 0,
                iv_load_policy: 3,
                start: Math.floor(startTime)
            },
            events: {
                'onReady': (e) => {
                    if (isLiveMode) {
                        document.body.classList.add('live-active');
                        e.target.playVideo();
                    }
                },
                'onStateChange': onPlayerStateChange,
                'onError': () => showToast("Error loading video")
            }
        });
        renderHistory();
    }

    function onPlayerStateChange(event) {
        if (event.data === YT.PlayerState.PLAYING) {
            startHeartbeat();
        } else {
            stopHeartbeat();
        }

        if (event.data === YT.PlayerState.ENDED && db.isLive) {
            unlockLiveMode();
        }
    }

    function startHeartbeat() {
        clearInterval(saveInterval);
        saveInterval = setInterval(() => {
            if (player && player.getCurrentTime) {
                const time = player.getCurrentTime();
                const dur = player.getDuration();
                if (time > 0) {
                    db.history[currentId] = { 
                        time, 
                        dur, 
                        thumb: `https://img.youtube.com/vi/${currentId}/mqdefault.jpg`,
                        updated: Date.now()
                    };
                    saveDb();
                }
            }
        }, 1000);
    }

    function stopHeartbeat() { clearInterval(saveInterval); }

    function startLiveSession(id) {
        db.isLive = true;
        db.activeLiveId = id;
        saveDb();
        initPlayer(id, true);
        showToast("THEATER LIVE MODE ACTIVE");
    }

    function unlockLiveMode() {
        db.isLive = false;
        db.activeLiveId = null;
        saveDb();
        document.body.classList.remove('live-active');
        showToast("Class Completed! Controls Unlocked.");
        initPlayer(currentId, false);
    }

    // Anti-Cheat: Tab Focus detection
    window.addEventListener('blur', () => {
        if (db.isLive && player && typeof player.pauseVideo === 'function') {
            player.pauseVideo();
            document.getElementById('focusWarning').style.display = 'flex';
        }
    });

    window.addEventListener('focus', () => {
        document.getElementById('focusWarning').style.display = 'none';
        if (db.isLive && player && typeof player.playVideo === 'function') {
            player.playVideo();
        }
    });

    // Block shortcuts in Live Mode
    window.addEventListener('keydown', (e) => {
        if (db.isLive) {
            const blocked = [' ', 'ArrowLeft', 'ArrowRight', 'j', 'k', 'l', 'f', 'm', 'Home', 'End'];
            if (blocked.includes(e.key)) {
                e.preventDefault();
                showToast("Shortcuts disabled in Live Mode");
            }
        }
    }, true);

    // UI Logic
    document.getElementById('loadBtn').onclick = () => {
        const val = document.getElementById('urlInput').value;
        const id = extractId(val);
        if (id) initPlayer(id);
        else showToast("Invalid YouTube URL");
    };

    document.getElementById('liveBtn').onclick = () => {
        if (!currentId) return showToast("Load a video first");
        startLiveSession(currentId);
    };

    function extractId(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : (url.length === 11 ? url : null);
    }

    function renderHistory() {
        const list = document.getElementById('historyList');
        list.innerHTML = '';
        const sortedKeys = Object.keys(db.history).sort((a,b) => db.history[b].updated - db.history[a].updated);
        
        sortedKeys.forEach(id => {
            const item = db.history[id];
            const div = document.createElement('div');
            div.className = 'hist-item';
            const progress = Math.round((item.time / item.dur) * 100) || 0;
            div.innerHTML = `
                <img src="${item.thumb}" class="hist-thumb">
                <div style="flex:1">
                    <div style="font-weight:bold; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:180px;">Video: ${id}</div>
                    <div style="height:4px; background:#222; margin:8px 0; border-radius:2px;">
                        <div style="width:${progress}%; height:100%; background:var(--primary);"></div>
                    </div>
                    <small style="color:var(--text-dim)">${progress}% completed</small>
                </div>
            `;
            div.onclick = () => {
                if (db.isLive) return showToast("Finish current session first");
                initPlayer(id);
            };
            list.appendChild(div);
        });
    }

    function showToast(m) {
        const t = document.getElementById('toast');
        t.innerText = m;
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 3000);
    }

    // Prevent navigation
    window.onbeforeunload = function() {
        if (db.isLive) return "Session in progress!";
    };

</script>
</body>
</html>
