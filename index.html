<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniPlayer Pro: Responsive & Stable</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23ff0033'/><path d='M35 30v40l35-20z' fill='white'/></svg>">
    <style>
        :root {
            --primary: #ff0033;
            --bg: #050505;
            --surface: #111114;
            --text: #ffffff;
            --text-dim: #707080;
            --border: #222228;
            --radius: 12px;
            --sidebar-width: 340px;
            --header-height: 60px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; background: var(--bg); color: var(--text); 
            font-family: 'Inter', system-ui, sans-serif; height: 100vh; 
            overflow: hidden;
        }

        .app-container {
            display: grid;
            grid-template-columns: 1fr var(--sidebar-width);
            grid-template-rows: var(--header-height) 1fr;
            height: 100vh;
            width: 100vw;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Mobile Adjustments */
        @media (max-width: 900px) {
            .app-container {
                grid-template-columns: 1fr;
                grid-template-rows: var(--header-height) 1fr 200px;
                overflow-y: auto;
                height: auto;
                min-height: 100vh;
            }
            body { overflow-y: auto; }
            .sidebar { border-left: none; border-top: 1px solid var(--border); }
        }

        body.live-active .app-container {
            grid-template-columns: 1fr 0px;
            grid-template-rows: 0px 1fr 0px;
        }

        header {
            grid-column: 1 / -1;
            background: #000;
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 100;
        }

        .logo { font-weight: 900; color: var(--primary); letter-spacing: -1px; }

        .stage {
            grid-column: 1; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            overflow-y: auto; position: relative;
        }

        body.live-active .stage { padding: 0; justify-content: center; background: #000; }

        .video-wrapper {
            width: 100%; max-width: 1000px;
            aspect-ratio: 16/9; background: #000;
            border-radius: var(--radius); position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            overflow: hidden;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.live-active .video-wrapper {
            max-width: 100vw; width: 100vw; height: 100vh;
            border-radius: 0; box-shadow: none;
        }

        #player { width: 100%; height: 100%; border: none; }

        .strict-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9999; display: none; background: rgba(0,0,0,0);
        }
        body.live-active .strict-overlay { display: block; }

        .live-banner {
            position: absolute; top: 20px; left: 20px; z-index: 10000;
            background: var(--primary); color: white; padding: 8px 16px;
            border-radius: 4px; font-weight: bold; font-size: 14px;
            display: none; animation: flash 2s infinite;
        }
        body.live-active .live-banner { display: block; }

        @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        .focus-warning {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 20000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; backdrop-filter: blur(15px); color: var(--primary);
        }

        .ui-panel { width: 100%; max-width: 600px; margin-top: 25px; transition: opacity 0.3s; }
        body.live-active .ui-panel { opacity: 0; pointer-events: none; display: none; }

        .input-row { display: flex; gap: 10px; }
        input {
            flex: 1; background: var(--surface); border: 1px solid var(--border);
            color: white; padding: 12px; border-radius: 8px; outline: none; min-width: 0;
        }
        button {
            background: var(--primary); color: white; border: none;
            padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer;
            flex-shrink: 0;
        }

        .sidebar { background: var(--surface); border-left: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
        body.live-active .sidebar { display: none; }

        .hist-item { padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; gap: 10px; font-size: 13px; }
        .hist-thumb { width: 100px; height: 56px; background: #000; border-radius: 4px; flex-shrink: 0; object-fit: cover; }

        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: var(--primary); color: white; padding: 12px 24px; border-radius: 30px;
            font-weight: bold; z-index: 100000; display: none;
        }
    </style>
</head>
<body oncontextmenu="return false;">

<div class="focus-warning" id="focusWarning">
    <h1 style="font-size: clamp(1.5rem, 5vw, 3rem);">ATTENTION REQUIRED</h1>
    <p>Video paused. Please return to this tab.</p>
</div>

<div class="app-container" id="mainContainer">
    <header>
        <div class="logo">OMNIPLAYER PRO</div>
        <button id="liveBtn" style="background: #222;">Live Mode</button>
    </header>

    <div class="stage">
        <div class="video-wrapper">
            <div class="live-banner" id="liveBanner">‚óè LIVE THEATER</div>
            <div class="strict-overlay" id="blocker"></div>
            <div id="player"></div>
        </div>
        <div class="ui-panel">
            <div class="input-row">
                <input type="text" id="urlInput" placeholder="Paste YouTube link...">
                <button id="loadBtn">LOAD</button>
            </div>
        </div>
    </div>

    <aside class="sidebar">
        <div style="padding: 20px; border-bottom: 1px solid var(--border); font-weight: bold;">HISTORY</div>
        <div id="historyList" style="overflow-y: auto; flex: 1;"></div>
    </aside>
</div>

<div id="toast" class="toast"></div>

<script>
    let player;
    let currentId = null;
    let saveInterval;
    let apiReady = false;

    // Aggressive state loading
    let db = JSON.parse(localStorage.getItem('omni_v10')) || { history: {}, activeLiveId: null, isLive: false, lastWatchedId: null };
    function saveDb() { localStorage.setItem('omni_v10', JSON.stringify(db)); }

    // Load YT API
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    const firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    function onYouTubeIframeAPIReady() {
        apiReady = true;
        bootApp();
    }

    function bootApp() {
        renderHistory();
        if (db.isLive && db.activeLiveId) {
            initPlayer(db.activeLiveId, true);
        } else if (db.lastWatchedId) {
            initPlayer(db.lastWatchedId, false);
        }
    }

    // Safety for reloads: if API is already there
    window.onload = () => {
        if (window.YT && window.YT.Player) {
            apiReady = true;
            bootApp();
        }
    };

    function initPlayer(id, isLiveMode = false) {
        if (!apiReady) return setTimeout(() => initPlayer(id, isLiveMode), 100);
        if (player && player.destroy) player.destroy();
        
        currentId = id;
        db.lastWatchedId = id;
        saveDb();
        
        const startTime = (db.history[id]?.time || 0);

        player = new YT.Player('player', {
            videoId: id,
            playerVars: {
                autoplay: 1,
                controls: isLiveMode ? 0 : 1,
                disablekb: isLiveMode ? 1 : 0,
                modestbranding: 1,
                rel: 0,
                start: Math.floor(startTime)
            },
            events: {
                'onReady': (e) => {
                    if (isLiveMode) document.body.classList.add('live-active');
                    e.target.playVideo();
                },
                'onStateChange': onPlayerStateChange
            }
        });
    }

    function onPlayerStateChange(event) {
        if (event.data === YT.PlayerState.PLAYING) startHeartbeat();
        else stopHeartbeat();

        if (event.data === YT.PlayerState.ENDED && db.isLive) unlockLiveMode();
    }

    function startHeartbeat() {
        clearInterval(saveInterval);
        saveInterval = setInterval(() => {
            if (player && player.getCurrentTime) {
                const time = player.getCurrentTime();
                const dur = player.getDuration();
                if (time > 0) {
                    db.history[currentId] = { 
                        time, dur, 
                        thumb: `https://img.youtube.com/vi/${currentId}/mqdefault.jpg`,
                        updated: Date.now()
                    };
                    saveDb();
                    renderHistory();
                }
            }
        }, 1000);
    }

    function stopHeartbeat() { clearInterval(saveInterval); }

    function unlockLiveMode() {
        db.isLive = false;
        db.activeLiveId = null;
        saveDb();
        document.body.classList.remove('live-active');
        initPlayer(currentId, false);
    }

    window.addEventListener('blur', () => {
        if (db.isLive && player?.pauseVideo) {
            player.pauseVideo();
            document.getElementById('focusWarning').style.display = 'flex';
        }
    });

    window.addEventListener('focus', () => {
        document.getElementById('focusWarning').style.display = 'none';
        if (db.isLive && player?.playVideo) player.playVideo();
    });

    document.getElementById('loadBtn').onclick = () => {
        const val = document.getElementById('urlInput').value;
        const id = extractId(val);
        if (id) initPlayer(id);
    };

    document.getElementById('liveBtn').onclick = () => {
        if (!currentId) return;
        db.isLive = true;
        db.activeLiveId = currentId;
        saveDb();
        initPlayer(currentId, true);
    };

    function extractId(url) {
        const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
        return (match && match[2].length === 11) ? match[2] : (url.length === 11 ? url : null);
    }

    function renderHistory() {
        const list = document.getElementById('historyList');
        if (!list) return;
        const items = Object.keys(db.history).sort((a,b) => db.history[b].updated - db.history[a].updated);
        list.innerHTML = items.map(id => {
            const it = db.history[id];
            const prog = Math.round((it.time / it.dur) * 100) || 0;
            return `
                <div class="hist-item" onclick="if(!db.isLive)initPlayer('${id}')">
                    <img src="${it.thumb}" class="hist-thumb">
                    <div style="flex:1; overflow:hidden;">
                        <div style="font-weight:bold; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">ID: ${id}</div>
                        <div style="height:4px; background:#222; margin:8px 0;"><div style="width:${prog}%; height:100%; background:var(--primary);"></div></div>
                        <small>${prog}% watched</small>
                    </div>
                </div>`;
        }).join('');
    }

    window.onbeforeunload = () => db.isLive ? "Class in progress!" : null;
</script>
</body>
</html>
