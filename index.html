<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniPlayer Ultimate v6.0</title>
    <style>
        /* বাংলা ভাষায় গাণিতিক/বর্ণনামূলক ব্যাখ্যা: */
        /* এটি একটি আধুনিক ডার্ক থিম। */
        :root {
            /* থিম ভ্যারিয়েবলস */
            --primary: #ff0033;
            --primary-hover: #d6002b;
            --bg: #0f0f12;
            --surface: #1a1a1f;
            --surface-hover: #25252b;
            --text: #ffffff;
            --text-dim: #888899;
            --border: #2a2a35;
            --radius: 14px;
            --font: 'Segoe UI', system-ui, sans-serif;
            --ease: cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        /* বেস রিসেট */
        * { box-sizing: border-box; outline: none; user-select: none; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: var(--font); height: 100vh; overflow: hidden; }

        /* অ্যাপ লেআউট */
        .app {
            display: grid;
            grid-template-columns: 1fr 350px;
            grid-template-rows: 60px 1fr;
            height: 100%;
            transition: all 0.5s var(--ease);
        }

        /* হেডার */
        header {
            grid-column: 1 / -1;
            background: rgba(15, 15, 18, 0.95);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 50;
            backdrop-filter: blur(10px);
        }
        .logo { font-weight: 800; font-size: 1.2rem; letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px; }
        .logo span { color: var(--primary); }
        
        .theatre-btn {
            background: var(--surface); border: 1px solid var(--border); color: var(--text-dim);
            padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; transition: 0.2s;
        }
        .theatre-btn:hover { color: var(--text); border-color: var(--text); }
        
        /* থিয়েটার মোড */
        body.theatre-mode .app { grid-template-columns: 1fr 0px; }
        body.theatre-mode .sidebar { opacity: 0; pointer-events: none; }

        /* মূল অংশ (প্লেয়ার) */
        .stage {
            grid-column: 1; grid-row: 2;
            padding: 30px;
            display: flex; flex-direction: column; align-items: center;
            overflow-y: auto;
        }

        .video-box {
            width: 100%; max-width: 1100px;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: var(--radius);
            box-shadow: 0 20px 50px -10px rgba(0,0,0,0.5);
            overflow: hidden;
            position: relative;
        }
        #player { width: 100%; height: 100%; }

        /* কন্ট্রোল ইনপুট */
        .controls {
            margin-top: 25px;
            width: 100%; max-width: 700px;
            display: flex; gap: 10px;
            position: relative;
        }
        
        .url-input {
            flex: 1; background: var(--surface); border: 1px solid var(--border);
            color: var(--text); padding: 14px 20px; border-radius: 12px;
            font-size: 0.95rem; transition: 0.2s;
        }
        
        .btn-main {
            background: var(--primary); color: white; border: none;
            padding: 0 25px; border-radius: 12px; font-weight: 600; cursor: pointer;
            transition: 0.2s; white-space: nowrap;
        }
        .btn-main:hover { background: var(--primary-hover); transform: translateY(-1px); }

        .status-txt { margin-top: 10px; color: var(--text-dim); font-size: 0.85rem; }

        /* সাইডবার */
        .sidebar {
            grid-column: 2; grid-row: 2;
            background: var(--surface);
            border-left: 1px solid var(--border);
            display: flex; flex-direction: column;
            overflow: hidden; transition: all 0.5s var(--ease);
        }

        .panel { padding: 20px; border-bottom: 1px solid var(--border); }
        .panel h3 { margin: 0 0 15px 0; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); }

        /* সেটিংস টগলস */
        .toggles { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .toggle {
            display: flex; align-items: center; gap: 8px; cursor: pointer;
            font-size: 0.85rem; color: var(--text-dim);
        }
        .toggle:hover { color: var(--text); }
        .toggle input { accent-color: var(--primary); width: 16px; height: 16px; margin: 0; }

        .override-input {
            width: 100%; background: var(--bg); border: 1px solid var(--border);
            color: var(--text); padding: 8px; border-radius: 6px; margin-top: 12px;
        }

        /* Apply Button */
        .btn-apply {
            width: 100%; margin-top: 15px; padding: 10px;
            background: var(--surface-hover); border: 1px solid var(--border);
            color: var(--text); border-radius: 8px; cursor: pointer; font-weight: 600;
            transition: 0.2s;
        }
        .btn-apply:hover { background: var(--border); color: white; }

        /* ইতিহাস তালিকা */
        .history-wrapper { flex: 1; overflow-y: auto; position: relative; }
        .history-list { list-style: none; padding: 0; margin: 0; }
        
        .history-item {
            display: flex; gap: 12px; padding: 12px 20px;
            border-bottom: 1px solid var(--border);
            cursor: pointer; transition: 0.2s; position: relative;
        }
        .history-item:hover { background: var(--surface-hover); }
        .history-item.active { border-left: 3px solid var(--primary); background: rgba(255,0,51,0.05); }

        .thumb {
            width: 80px; height: 50px; border-radius: 6px; background: #000;
            overflow: hidden; position: relative; flex-shrink: 0;
        }
        .thumb img { width: 100%; height: 100%; object-fit: cover; opacity: 0.7; }
        
        .progress-bar {
            position: absolute; bottom: 0; left: 0; height: 3px; background: rgba(255,255,255,0.2); width: 100%;
            /* NEW: অপশন অনুসারে প্রগ্রেস বার দেখা বা লুকানো হবে */
            transition: opacity 0.3s;
        }
        /* যদি প্রগ্রেস বার লুকানো থাকে */
        .no-progress .progress-bar { opacity: 0; }

        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }

        .info { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; }
        .title { font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .meta { font-size: 0.75rem; color: var(--text-dim); margin-top: 4px; }
        
        .del-btn {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            background: none; border: none; color: #ff4444; cursor: pointer;
            opacity: 0; padding: 5px; transition: 0.2s;
        }
        .history-item:hover .del-btn { opacity: 1; }

        /* টোস্ট মেসেজ */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: var(--text); color: var(--bg); padding: 10px 20px;
            border-radius: 30px; font-weight: 600; font-size: 0.9rem;
            opacity: 0; pointer-events: none; transition: 0.3s; z-index: 100;
        }
        .toast.visible { opacity: 1; transform: translateX(-50%) translateY(-10px); }

        /* রেসপনসিভনেস */
        @media (max-width: 900px) {
            .app { grid-template-columns: 1fr; grid-template-rows: auto auto 1fr; overflow-y: auto; }
            .stage { padding: 15px; grid-row: 2; }
            .sidebar { grid-column: 1; grid-row: 3; border-left: none; border-top: 1px solid var(--border); max-height: none; overflow: visible; }
            body.theatre-mode .sidebar { display: none; }
        }
    </style>
</head>
<body>

<div class="app">
    <header>
        <div class="logo"><span>◆</span> OmniPlayer</div>
        <button class="theatre-btn" id="theatreToggle">Theatre Mode [T]</button>
    </header>

    <div class="stage">
        <div class="video-box">
            <div id="player"></div>
        </div>

        <div class="controls">
            <input type="text" id="urlInput" class="url-input" placeholder="YouTube URL or ID (Ctrl+V)">
            <button class="btn-main" id="playBtn">Play</button>
        </div>
        <div class="status-txt" id="status">Waiting for input...</div>
    </div>

    <aside class="sidebar">
        <div class="panel">
            <h3>Playback Settings</h3>
            <div class="toggles">
                <label class="toggle"><input type="checkbox" id="set-auto" checked> Autoplay</label>
                <label class="toggle"><input type="checkbox" id="set-mute"> Mute Start</label>
                <label class="toggle"><input type="checkbox" id="set-loop"> Loop</label>
                <label class="toggle"><input type="checkbox" id="set-controls" checked> Show Controls</label> <label class="toggle"><input type="checkbox" id="set-ui"> Clean UI</label>
                <label class="toggle"><input type="checkbox" id="set-progress" checked> Always Show Progress</label> </div>
            <input type="number" id="set-start" class="override-input" placeholder="Force start time (seconds)...">
            
            <button class="btn-apply" id="applySettingsBtn">Apply Changes & Reload</button>
        </div>

        <div class="panel" style="padding-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
            <h3>History</h3>
            <span style="font-size:0.7rem; color:var(--text-dim); cursor:pointer;" onclick="clearHistory()">CLEAR ALL</span>
        </div>

        <div class="history-wrapper" id="historyWrapper">
            <ul class="history-list" id="historyList"></ul>
        </div>
    </aside>
</div>

<div class="toast" id="toast"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
    // --- স্টেট এবং কনফিগ ---
    const STATE_KEY = 'omni_ultimate_db';
    let player = null;
    let saveTimer = null;
    
    // স্থায়ী ডেটা লোড করুন
    let db = JSON.parse(localStorage.getItem(STATE_KEY)) || { history: {} };
    let currentId = null;

    // এলিমেন্টস
    const els = {
        input: document.getElementById('urlInput'),
        status: document.getElementById('status'),
        list: document.getElementById('historyList'),
        body: document.body,
        theatreBtn: document.getElementById('theatreToggle'),
        applyBtn: document.getElementById('applySettingsBtn'),
        historyWrapper: document.getElementById('historyWrapper'),
        settings: {
            auto: document.getElementById('set-auto'),
            mute: document.getElementById('set-mute'),
            loop: document.getElementById('set-loop'),
            controls: document.getElementById('set-controls'), // নতুন কন্ট্রোলস
            ui: document.getElementById('set-ui'),
            start: document.getElementById('set-start'),
            progress: document.getElementById('set-progress'), // নতুন প্রোগ্রেস অপশন
        }
    };

    // --- কোর লজিক ---

    function onYouTubeIframeAPIReady() {
        showToast("সিস্টেম প্রস্তুত");
        // প্রগ্রেস বার স্টাইল ইনিশিয়ালাইজ করুন
        updateProgressVisibility();
    }

    // প্রগ্রেস বারের দৃশ্যমানতা নিয়ন্ত্রণ করে
    function updateProgressVisibility() {
        if (els.settings.progress.checked) {
            els.historyWrapper.classList.remove('no-progress');
        } else {
            els.historyWrapper.classList.add('no-progress');
        }
    }

    function parseId(url) {
        if (!url) return null;
        const match = url.match(/(?:youtu\.be\/|v\/|embed\/|shorts\/|watch\?v=|&v=)([^#&?]*)/);
        return (match && match[1].length === 11) ? match[1] : (url.length === 11 ? url : null);
    }

    function initVideo(forceId = null) {
        // ফর্স আইডি, অথবা বর্তমান লোড হওয়া আইডি, অথবা ইনপুট থেকে আইডি ব্যবহার করুন
        const id = forceId || currentId || parseId(els.input.value);
        
        if (!id) {
            if(els.input.value.trim() !== "") showToast("অকার্যকর URL বা আইডি");
            return;
        }

        currentId = id;
        
        // ১. শুরুর সময় নির্ধারণ করুন
        let startTime = 0;
        const historyEntry = db.history[id];
        
        if (els.settings.start.value) {
            startTime = parseInt(els.settings.start.value);
            els.status.innerText = `ম্যানুয়াল শুরু: ${fmtTime(startTime)}`;
        } 
        else if (historyEntry && historyEntry.time > 10) {
            startTime = Math.floor(historyEntry.time);
            els.status.innerText = `এখান থেকে চলছে: ${fmtTime(startTime)}`;
        } else {
            els.status.innerText = `নতুন ভিডিও শুরু হচ্ছে`;
        }

        // ২. প্লেয়ার সেটআপ করুন
        if (player) {
            player.destroy();
            clearInterval(saveTimer);
        }

        const vars = {
            playsinline: 1,
            rel: 0,
            fs: 1,
            start: startTime,
            controls: els.settings.controls.checked ? 1 : 0, // নতুন অপশন প্রয়োগ
            modestbranding: els.settings.ui.checked ? 1 : 0,
            loop: els.settings.loop.checked ? 1 : 0,
        };
        if (vars.loop) vars.playlist = id;

        player = new YT.Player('player', {
            videoId: id,
            width: '100%', height: '100%',
            playerVars: vars,
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange,
                'onError': (e) => showToast(`ত্রুটি ${e.data}`)
            }
        });

        // ৩. ইউআই আপডেট
        if(!forceId && !currentId) els.input.value = ""; 
        renderHistory(); 
    }

    function onPlayerReady(e) {
        if (els.settings.auto.checked) {
            if (els.settings.mute.checked) e.target.mute();
            e.target.playVideo();
        }
    }

    function onPlayerStateChange(e) {
        // যখন ভিডিও চলছে তখনই কেবল সেভ করা শুরু হবে
        if (e.data === YT.PlayerState.PLAYING) {
            startSaving();
        } else {
            clearInterval(saveTimer);
        }
    }

    // --- সেভ লজিক ---
    function startSaving() {
        clearInterval(saveTimer);
        saveTimer = setInterval(() => {
            if (!player || !player.getCurrentTime) return;
            const t = player.getCurrentTime();
            const d = player.getDuration();
            
            // সুরক্ষা চেক: লোডিং গ্লিচ এড়াতে t < 1 এবং d > 0 হলে সেভ করব না
            if (t < 1 && d > 0) return;

            db.history[currentId] = { id: currentId, time: t, duration: d, ts: Date.now() };
            persist();
        }, 3000); 
    }

    function persist() {
        localStorage.setItem(STATE_KEY, JSON.stringify(db));
    }

    // --- ইউআই রেন্ডারিং ---

    function fmtTime(s) {
        if (!s) return "0:00";
        const date = new Date(0); date.setSeconds(s);
        // সময়কে H:MM:SS বা M:SS ফরম্যাটে দেখান
        return date.toISOString().substr(11, 8).replace(/^00:/, '');
    }

    function renderHistory() {
        const list = els.list;
        list.innerHTML = '';
        
        const sorted = Object.values(db.history).sort((a, b) => b.ts - a.ts);
        
        if (sorted.length === 0) {
            list.innerHTML = '<li style="padding:20px; text-align:center; color:var(--text-dim)">কোন ইতিহাস নেই</li>';
            return;
        }

        sorted.forEach(item => {
            const pct = item.duration ? (item.time / item.duration) * 100 : 0;
            const li = document.createElement('li');
            li.className = `history-item ${currentId === item.id ? 'active' : ''}`;
            li.onclick = () => initVideo(item.id);

            li.innerHTML = `
                <div class="thumb">
                    <img src="https://img.youtube.com/vi/${item.id}/mqdefault.jpg" loading="lazy">
                    <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
                </div>
                <div class="info">
                    <div class="title">${item.id}</div>
                    <div class="meta">${fmtTime(item.time)} / ${fmtTime(item.duration)}</div>
                </div>
                <button class="del-btn" onclick="delHistory(event, '${item.id}')">✕</button>
            `;
            list.appendChild(li);
        });
    }

    function delHistory(e, id) {
        e.stopPropagation();
        delete db.history[id];
        persist();
        renderHistory();
    }

    function clearHistory() {
        if(confirm("সব ইতিহাস মুছে ফেলবেন?")) {
            db.history = {};
            persist();
            renderHistory();
        }
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('visible');
        setTimeout(() => t.classList.remove('visible'), 2500);
    }

    // --- থিয়েটার মোড ---
    let isTheatre = false;
    function toggleTheatre() {
        isTheatre = !isTheatre;
        els.body.classList.toggle('theatre-mode', isTheatre);
        els.theatreBtn.innerText = isTheatre ? "Exit Theatre [T]" : "Theatre Mode [T]";
        showToast(isTheatre ? "থিয়েটার মোড চালু" : "থিয়েটার মোড বন্ধ");
    }

    // --- ইভেন্ট লিসেনার্স ---
    document.getElementById('playBtn').addEventListener('click', () => {
        const id = parseId(els.input.value);
        if(id) initVideo(id);
        else showToast("অনুগ্রহ করে একটি URL পেস্ট করুন");
    });

    // সেটিংস প্রয়োগ এবং প্লেয়ার রিলোড
    els.applyBtn.addEventListener('click', () => {
        if(currentId) {
            initVideo(currentId);
            showToast("সেটিংস প্রয়োগ করা হলো এবং প্লেয়ার রিলোড হয়েছে");
        } else {
            showToast("কোন ভিডিও বর্তমানে লোড নেই");
        }
    });
    
    // প্রগ্রেস অপশন পরিবর্তন হলে সাথে সাথে ইউআই আপডেট করুন
    els.settings.progress.addEventListener('change', updateProgressVisibility);

    els.input.addEventListener('keypress', e => {
        if (e.key === 'Enter') {
             const id = parseId(els.input.value);
             if(id) initVideo(id);
        }
    });

    els.theatreBtn.addEventListener('click', toggleTheatre);
    
    document.addEventListener('keydown', (e) => {
        if (e.key.toLowerCase() === 't' && document.activeElement.tagName !== 'INPUT') {
            toggleTheatre();
        }
    });

    // ইনিশিয়ালাইজেশন
    renderHistory();

</script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniPlayer Ultimate v6.0</title>
    <style>
        /* বাংলা ভাষায় গাণিতিক/বর্ণনামূলক ব্যাখ্যা: */
        /* এটি একটি আধুনিক ডার্ক থিম। */
        :root {
            /* থিম ভ্যারিয়েবলস */
            --primary: #ff0033;
            --primary-hover: #d6002b;
            --bg: #0f0f12;
            --surface: #1a1a1f;
            --surface-hover: #25252b;
            --text: #ffffff;
            --text-dim: #888899;
            --border: #2a2a35;
            --radius: 14px;
            --font: 'Segoe UI', system-ui, sans-serif;
            --ease: cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        /* বেস রিসেট */
        * { box-sizing: border-box; outline: none; user-select: none; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: var(--font); height: 100vh; overflow: hidden; }

        /* অ্যাপ লেআউট */
        .app {
            display: grid;
            grid-template-columns: 1fr 350px;
            grid-template-rows: 60px 1fr;
            height: 100%;
            transition: all 0.5s var(--ease);
        }

        /* হেডার */
        header {
            grid-column: 1 / -1;
            background: rgba(15, 15, 18, 0.95);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 50;
            backdrop-filter: blur(10px);
        }
        .logo { font-weight: 800; font-size: 1.2rem; letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px; }
        .logo span { color: var(--primary); }
        
        .theatre-btn {
            background: var(--surface); border: 1px solid var(--border); color: var(--text-dim);
            padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; transition: 0.2s;
        }
        .theatre-btn:hover { color: var(--text); border-color: var(--text); }
        
        /* থিয়েটার মোড */
        body.theatre-mode .app { grid-template-columns: 1fr 0px; }
        body.theatre-mode .sidebar { opacity: 0; pointer-events: none; }

        /* মূল অংশ (প্লেয়ার) */
        .stage {
            grid-column: 1; grid-row: 2;
            padding: 30px;
            display: flex; flex-direction: column; align-items: center;
            overflow-y: auto;
        }

        .video-box {
            width: 100%; max-width: 1100px;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: var(--radius);
            box-shadow: 0 20px 50px -10px rgba(0,0,0,0.5);
            overflow: hidden;
            position: relative;
        }
        #player { width: 100%; height: 100%; }

        /* কন্ট্রোল ইনপুট */
        .controls {
            margin-top: 25px;
            width: 100%; max-width: 700px;
            display: flex; gap: 10px;
            position: relative;
        }
        
        .url-input {
            flex: 1; background: var(--surface); border: 1px solid var(--border);
            color: var(--text); padding: 14px 20px; border-radius: 12px;
            font-size: 0.95rem; transition: 0.2s;
        }
        
        .btn-main {
            background: var(--primary); color: white; border: none;
            padding: 0 25px; border-radius: 12px; font-weight: 600; cursor: pointer;
            transition: 0.2s; white-space: nowrap;
        }
        .btn-main:hover { background: var(--primary-hover); transform: translateY(-1px); }

        .status-txt { margin-top: 10px; color: var(--text-dim); font-size: 0.85rem; }

        /* সাইডবার */
        .sidebar {
            grid-column: 2; grid-row: 2;
            background: var(--surface);
            border-left: 1px solid var(--border);
            display: flex; flex-direction: column;
            overflow: hidden; transition: all 0.5s var(--ease);
        }

        .panel { padding: 20px; border-bottom: 1px solid var(--border); }
        .panel h3 { margin: 0 0 15px 0; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); }

        /* সেটিংস টগলস */
        .toggles { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .toggle {
            display: flex; align-items: center; gap: 8px; cursor: pointer;
            font-size: 0.85rem; color: var(--text-dim);
        }
        .toggle:hover { color: var(--text); }
        .toggle input { accent-color: var(--primary); width: 16px; height: 16px; margin: 0; }

        .override-input {
            width: 100%; background: var(--bg); border: 1px solid var(--border);
            color: var(--text); padding: 8px; border-radius: 6px; margin-top: 12px;
        }

        /* Apply Button */
        .btn-apply {
            width: 100%; margin-top: 15px; padding: 10px;
            background: var(--surface-hover); border: 1px solid var(--border);
            color: var(--text); border-radius: 8px; cursor: pointer; font-weight: 600;
            transition: 0.2s;
        }
        .btn-apply:hover { background: var(--border); color: white; }

        /* ইতিহাস তালিকা */
        .history-wrapper { flex: 1; overflow-y: auto; position: relative; }
        .history-list { list-style: none; padding: 0; margin: 0; }
        
        .history-item {
            display: flex; gap: 12px; padding: 12px 20px;
            border-bottom: 1px solid var(--border);
            cursor: pointer; transition: 0.2s; position: relative;
        }
        .history-item:hover { background: var(--surface-hover); }
        .history-item.active { border-left: 3px solid var(--primary); background: rgba(255,0,51,0.05); }

        .thumb {
            width: 80px; height: 50px; border-radius: 6px; background: #000;
            overflow: hidden; position: relative; flex-shrink: 0;
        }
        .thumb img { width: 100%; height: 100%; object-fit: cover; opacity: 0.7; }
        
        .progress-bar {
            position: absolute; bottom: 0; left: 0; height: 3px; background: rgba(255,255,255,0.2); width: 100%;
            /* NEW: অপশন অনুসারে প্রগ্রেস বার দেখা বা লুকানো হবে */
            transition: opacity 0.3s;
        }
        /* যদি প্রগ্রেস বার লুকানো থাকে */
        .no-progress .progress-bar { opacity: 0; }

        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }

        .info { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; }
        .title { font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .meta { font-size: 0.75rem; color: var(--text-dim); margin-top: 4px; }
        
        .del-btn {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            background: none; border: none; color: #ff4444; cursor: pointer;
            opacity: 0; padding: 5px; transition: 0.2s;
        }
        .history-item:hover .del-btn { opacity: 1; }

        /* টোস্ট মেসেজ */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: var(--text); color: var(--bg); padding: 10px 20px;
            border-radius: 30px; font-weight: 600; font-size: 0.9rem;
            opacity: 0; pointer-events: none; transition: 0.3s; z-index: 100;
        }
        .toast.visible { opacity: 1; transform: translateX(-50%) translateY(-10px); }

        /* রেসপনসিভনেস */
        @media (max-width: 900px) {
            .app { grid-template-columns: 1fr; grid-template-rows: auto auto 1fr; overflow-y: auto; }
            .stage { padding: 15px; grid-row: 2; }
            .sidebar { grid-column: 1; grid-row: 3; border-left: none; border-top: 1px solid var(--border); max-height: none; overflow: visible; }
            body.theatre-mode .sidebar { display: none; }
        }
    </style>
</head>
<body>

<div class="app">
    <header>
        <div class="logo"><span>◆</span> OmniPlayer</div>
        <button class="theatre-btn" id="theatreToggle">Theatre Mode [T]</button>
    </header>

    <div class="stage">
        <div class="video-box">
            <div id="player"></div>
        </div>

        <div class="controls">
            <input type="text" id="urlInput" class="url-input" placeholder="YouTube URL or ID (Ctrl+V)">
            <button class="btn-main" id="playBtn">Play</button>
        </div>
        <div class="status-txt" id="status">Waiting for input...</div>
    </div>

    <aside class="sidebar">
        <div class="panel">
            <h3>Playback Settings</h3>
            <div class="toggles">
                <label class="toggle"><input type="checkbox" id="set-auto" checked> Autoplay</label>
                <label class="toggle"><input type="checkbox" id="set-mute"> Mute Start</label>
                <label class="toggle"><input type="checkbox" id="set-loop"> Loop</label>
                <label class="toggle"><input type="checkbox" id="set-controls" checked> Show Controls</label> <label class="toggle"><input type="checkbox" id="set-ui"> Clean UI</label>
                <label class="toggle"><input type="checkbox" id="set-progress" checked> Always Show Progress</label> </div>
            <input type="number" id="set-start" class="override-input" placeholder="Force start time (seconds)...">
            
            <button class="btn-apply" id="applySettingsBtn">Apply Changes & Reload</button>
        </div>

        <div class="panel" style="padding-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
            <h3>History</h3>
            <span style="font-size:0.7rem; color:var(--text-dim); cursor:pointer;" onclick="clearHistory()">CLEAR ALL</span>
        </div>

        <div class="history-wrapper" id="historyWrapper">
            <ul class="history-list" id="historyList"></ul>
        </div>
    </aside>
</div>

<div class="toast" id="toast"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
    // --- স্টেট এবং কনফিগ ---
    const STATE_KEY = 'omni_ultimate_db';
    let player = null;
    let saveTimer = null;
    
    // স্থায়ী ডেটা লোড করুন
    let db = JSON.parse(localStorage.getItem(STATE_KEY)) || { history: {} };
    let currentId = null;

    // এলিমেন্টস
    const els = {
        input: document.getElementById('urlInput'),
        status: document.getElementById('status'),
        list: document.getElementById('historyList'),
        body: document.body,
        theatreBtn: document.getElementById('theatreToggle'),
        applyBtn: document.getElementById('applySettingsBtn'),
        historyWrapper: document.getElementById('historyWrapper'),
        settings: {
            auto: document.getElementById('set-auto'),
            mute: document.getElementById('set-mute'),
            loop: document.getElementById('set-loop'),
            controls: document.getElementById('set-controls'), // নতুন কন্ট্রোলস
            ui: document.getElementById('set-ui'),
            start: document.getElementById('set-start'),
            progress: document.getElementById('set-progress'), // নতুন প্রোগ্রেস অপশন
        }
    };

    // --- কোর লজিক ---

    function onYouTubeIframeAPIReady() {
        showToast("সিস্টেম প্রস্তুত");
        // প্রগ্রেস বার স্টাইল ইনিশিয়ালাইজ করুন
        updateProgressVisibility();
    }

    // প্রগ্রেস বারের দৃশ্যমানতা নিয়ন্ত্রণ করে
    function updateProgressVisibility() {
        if (els.settings.progress.checked) {
            els.historyWrapper.classList.remove('no-progress');
        } else {
            els.historyWrapper.classList.add('no-progress');
        }
    }

    function parseId(url) {
        if (!url) return null;
        const match = url.match(/(?:youtu\.be\/|v\/|embed\/|shorts\/|watch\?v=|&v=)([^#&?]*)/);
        return (match && match[1].length === 11) ? match[1] : (url.length === 11 ? url : null);
    }

    function initVideo(forceId = null) {
        // ফর্স আইডি, অথবা বর্তমান লোড হওয়া আইডি, অথবা ইনপুট থেকে আইডি ব্যবহার করুন
        const id = forceId || currentId || parseId(els.input.value);
        
        if (!id) {
            if(els.input.value.trim() !== "") showToast("অকার্যকর URL বা আইডি");
            return;
        }

        currentId = id;
        
        // ১. শুরুর সময় নির্ধারণ করুন
        let startTime = 0;
        const historyEntry = db.history[id];
        
        if (els.settings.start.value) {
            startTime = parseInt(els.settings.start.value);
            els.status.innerText = `ম্যানুয়াল শুরু: ${fmtTime(startTime)}`;
        } 
        else if (historyEntry && historyEntry.time > 10) {
            startTime = Math.floor(historyEntry.time);
            els.status.innerText = `এখান থেকে চলছে: ${fmtTime(startTime)}`;
        } else {
            els.status.innerText = `নতুন ভিডিও শুরু হচ্ছে`;
        }

        // ২. প্লেয়ার সেটআপ করুন
        if (player) {
            player.destroy();
            clearInterval(saveTimer);
        }

        const vars = {
            playsinline: 1,
            rel: 0,
            fs: 1,
            start: startTime,
            controls: els.settings.controls.checked ? 1 : 0, // নতুন অপশন প্রয়োগ
            modestbranding: els.settings.ui.checked ? 1 : 0,
            loop: els.settings.loop.checked ? 1 : 0,
        };
        if (vars.loop) vars.playlist = id;

        player = new YT.Player('player', {
            videoId: id,
            width: '100%', height: '100%',
            playerVars: vars,
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange,
                'onError': (e) => showToast(`ত্রুটি ${e.data}`)
            }
        });

        // ৩. ইউআই আপডেট
        if(!forceId && !currentId) els.input.value = ""; 
        renderHistory(); 
    }

    function onPlayerReady(e) {
        if (els.settings.auto.checked) {
            if (els.settings.mute.checked) e.target.mute();
            e.target.playVideo();
        }
    }

    function onPlayerStateChange(e) {
        // যখন ভিডিও চলছে তখনই কেবল সেভ করা শুরু হবে
        if (e.data === YT.PlayerState.PLAYING) {
            startSaving();
        } else {
            clearInterval(saveTimer);
        }
    }

    // --- সেভ লজিক ---
    function startSaving() {
        clearInterval(saveTimer);
        saveTimer = setInterval(() => {
            if (!player || !player.getCurrentTime) return;
            const t = player.getCurrentTime();
            const d = player.getDuration();
            
            // সুরক্ষা চেক: লোডিং গ্লিচ এড়াতে t < 1 এবং d > 0 হলে সেভ করব না
            if (t < 1 && d > 0) return;

            db.history[currentId] = { id: currentId, time: t, duration: d, ts: Date.now() };
            persist();
        }, 3000); 
    }

    function persist() {
        localStorage.setItem(STATE_KEY, JSON.stringify(db));
    }

    // --- ইউআই রেন্ডারিং ---

    function fmtTime(s) {
        if (!s) return "0:00";
        const date = new Date(0); date.setSeconds(s);
        // সময়কে H:MM:SS বা M:SS ফরম্যাটে দেখান
        return date.toISOString().substr(11, 8).replace(/^00:/, '');
    }

    function renderHistory() {
        const list = els.list;
        list.innerHTML = '';
        
        const sorted = Object.values(db.history).sort((a, b) => b.ts - a.ts);
        
        if (sorted.length === 0) {
            list.innerHTML = '<li style="padding:20px; text-align:center; color:var(--text-dim)">কোন ইতিহাস নেই</li>';
            return;
        }

        sorted.forEach(item => {
            const pct = item.duration ? (item.time / item.duration) * 100 : 0;
            const li = document.createElement('li');
            li.className = `history-item ${currentId === item.id ? 'active' : ''}`;
            li.onclick = () => initVideo(item.id);

            li.innerHTML = `
                <div class="thumb">
                    <img src="https://img.youtube.com/vi/${item.id}/mqdefault.jpg" loading="lazy">
                    <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
                </div>
                <div class="info">
                    <div class="title">${item.id}</div>
                    <div class="meta">${fmtTime(item.time)} / ${fmtTime(item.duration)}</div>
                </div>
                <button class="del-btn" onclick="delHistory(event, '${item.id}')">✕</button>
            `;
            list.appendChild(li);
        });
    }

    function delHistory(e, id) {
        e.stopPropagation();
        delete db.history[id];
        persist();
        renderHistory();
    }

    function clearHistory() {
        if(confirm("সব ইতিহাস মুছে ফেলবেন?")) {
            db.history = {};
            persist();
            renderHistory();
        }
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('visible');
        setTimeout(() => t.classList.remove('visible'), 2500);
    }

    // --- থিয়েটার মোড ---
    let isTheatre = false;
    function toggleTheatre() {
        isTheatre = !isTheatre;
        els.body.classList.toggle('theatre-mode', isTheatre);
        els.theatreBtn.innerText = isTheatre ? "Exit Theatre [T]" : "Theatre Mode [T]";
        showToast(isTheatre ? "থিয়েটার মোড চালু" : "থিয়েটার মোড বন্ধ");
    }

    // --- ইভেন্ট লিসেনার্স ---
    document.getElementById('playBtn').addEventListener('click', () => {
        const id = parseId(els.input.value);
        if(id) initVideo(id);
        else showToast("অনুগ্রহ করে একটি URL পেস্ট করুন");
    });

    // সেটিংস প্রয়োগ এবং প্লেয়ার রিলোড
    els.applyBtn.addEventListener('click', () => {
        if(currentId) {
            initVideo(currentId);
            showToast("সেটিংস প্রয়োগ করা হলো এবং প্লেয়ার রিলোড হয়েছে");
        } else {
            showToast("কোন ভিডিও বর্তমানে লোড নেই");
        }
    });
    
    // প্রগ্রেস অপশন পরিবর্তন হলে সাথে সাথে ইউআই আপডেট করুন
    els.settings.progress.addEventListener('change', updateProgressVisibility);

    els.input.addEventListener('keypress', e => {
        if (e.key === 'Enter') {
             const id = parseId(els.input.value);
             if(id) initVideo(id);
        }
    });

    els.theatreBtn.addEventListener('click', toggleTheatre);
    
    document.addEventListener('keydown', (e) => {
        if (e.key.toLowerCase() === 't' && document.activeElement.tagName !== 'INPUT') {
            toggleTheatre();
        }
    });

    // ইনিশিয়ালাইজেশন
    renderHistory();

</script>
</body>
</html>
