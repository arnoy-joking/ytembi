<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniPlayer Ultimate v7.0 - Enhanced with Live Mode</title>
    <style>
        :root {
            --primary: #ff0033;
            --primary-hover: #d6002b;
            --live-red: #ff3838;
            --live-pulse: rgba(255, 56, 56, 0.4);
            --bg: #0f0f12;
            --surface: #1a1a1f;
            --surface-hover: #25252b;
            --text: #ffffff;
            --text-dim: #888899;
            --border: #2a2a35;
            --radius: 14px;
            --font: 'Segoe UI', system-ui, sans-serif;
            --ease: cubic-bezier(0.2, 0.8, 0.2, 1);
            --overlay: rgba(0, 0, 0, 0.92);
        }

        * { box-sizing: border-box; outline: none; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: var(--font); height: 100vh; overflow: hidden; }

        /* Live Mode Overlay - Strict Lock */
        .live-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--overlay);
            z-index: 10000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 30px;
            user-select: none;
            backdrop-filter: blur(10px);
        }

        .live-overlay.active {
            display: flex;
        }

        .live-indicator {
            background: var(--live-red);
            color: white;
            padding: 10px 25px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 1.1rem;
            letter-spacing: 1px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: pulse 2s infinite;
            box-shadow: 0 0 30px var(--live-pulse);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 10px var(--live-pulse); }
            50% { box-shadow: 0 0 40px var(--live-pulse); }
            100% { box-shadow: 0 0 10px var(--live-pulse); }
        }

        .live-icon {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            display: inline-block;
        }

        .live-timer {
            font-size: 3rem;
            font-weight: 300;
            font-variant-numeric: tabular-nums;
            margin: 20px 0;
            color: white;
            font-family: 'Courier New', monospace;
        }

        .live-message {
            color: var(--text-dim);
            max-width: 500px;
            line-height: 1.6;
            margin: 20px 0;
        }

        .live-class-info {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: var(--radius);
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 500px;
            text-align: left;
        }

        .live-class-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: white;
        }

        .live-class-stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            font-size: 0.9rem;
            color: var(--text-dim);
        }

        /* Enhanced App Layout */
        .app {
            display: grid;
            grid-template-columns: 1fr 350px;
            grid-template-rows: 60px 1fr;
            height: 100%;
            transition: all 0.5s var(--ease);
        }

        /* Enhanced Header with Live Controls */
        header {
            grid-column: 1 / -1;
            background: rgba(15, 15, 18, 0.95);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 50;
            backdrop-filter: blur(10px);
        }

        .logo {
            font-weight: 800;
            font-size: 1.2rem;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo span { color: var(--primary); }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .theatre-btn, .live-btn {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: 0.2s;
            white-space: nowrap;
        }

        .live-btn {
            border-color: var(--live-red);
            color: var(--live-red);
        }

        .live-btn.active {
            background: var(--live-red);
            color: white;
        }

        .theatre-btn:hover { color: var(--text); border-color: var(--text); }
        .live-btn:hover:not(.active) { background: rgba(255, 56, 56, 0.1); }

        /* Theatre Mode */
        body.theatre-mode .app { grid-template-columns: 1fr 0px; }
        body.theatre-mode .sidebar { opacity: 0; pointer-events: none; }
        body.live-mode .app { filter: blur(3px); pointer-events: none; }
        body.live-mode .live-overlay { display: flex; }

        /* Main Stage */
        .stage {
            grid-column: 1;
            grid-row: 2;
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
        }

        .video-box {
            width: 100%;
            max-width: 1100px;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: var(--radius);
            box-shadow: 0 20px 50px -10px rgba(0,0,0,0.5);
            overflow: hidden;
            position: relative;
            transition: transform 0.3s var(--ease);
        }

        body.live-mode .video-box {
            transform: scale(0.95);
        }

        #player { width: 100%; height: 100%; }

        /* Enhanced Controls */
        .controls {
            margin-top: 25px;
            width: 100%;
            max-width: 700px;
            display: flex;
            gap: 10px;
            position: relative;
        }

        .url-input {
            flex: 1;
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 14px 20px;
            border-radius: 12px;
            font-size: 0.95rem;
            transition: 0.2s;
        }

        .btn-main {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0 25px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            white-space: nowrap;
        }

        .btn-main:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .btn-live { background: var(--live-red); }
        .btn-live:hover { background: #ff1a1a; }

        .status-txt {
            margin-top: 10px;
            color: var(--text-dim);
            font-size: 0.85rem;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .live-status {
            color: var(--live-red);
            font-weight: 600;
            display: none;
        }

        .live-status.active { display: block; }

        /* Enhanced Sidebar */
        .sidebar {
            grid-column: 2;
            grid-row: 2;
            background: var(--surface);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.5s var(--ease);
        }

        .panel {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .panel h3 {
            margin: 0 0 15px 0;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
        }

        /* Live Mode Settings */
        .live-settings {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .duration-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .duration-input input {
            width: 80px;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }

        .duration-input select {
            flex: 1;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px;
            border-radius: 6px;
        }

        /* Enhanced Toggles */
        .toggles {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .toggle:hover { color: var(--text); }
        .toggle input { accent-color: var(--primary); width: 16px; height: 16px; margin: 0; }

        .override-input {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px;
            border-radius: 6px;
            margin-top: 12px;
        }

        .btn-apply {
            width: 100%;
            margin-top: 15px;
            padding: 10px;
            background: var(--surface-hover);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
        }

        .btn-apply:hover { background: var(--border); color: white; }

        /* Enhanced History */
        .history-wrapper {
            flex: 1;
            overflow-y: auto;
            position: relative;
        }

        .history-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .history-item {
            display: flex;
            gap: 12px;
            padding: 12px 20px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: 0.2s;
            position: relative;
        }

        .history-item:hover { background: var(--surface-hover); }
        .history-item.active { border-left: 3px solid var(--primary); background: rgba(255,0,51,0.05); }
        .history-item.live { border-left: 3px solid var(--live-red); }

        .thumb {
            width: 80px;
            height: 50px;
            border-radius: 6px;
            background: #000;
            overflow: hidden;
            position: relative;
            flex-shrink: 0;
        }

        .thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.7;
        }

        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: rgba(255,255,255,0.2);
            width: 100%;
            transition: opacity 0.3s;
        }

        .no-progress .progress-bar { opacity: 0; }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s;
        }

        .info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .title {
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .meta {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-top: 4px;
            display: flex;
            gap: 10px;
        }

        .live-badge {
            background: var(--live-red);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .del-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #ff4444;
            cursor: pointer;
            opacity: 0;
            padding: 5px;
            transition: 0.2s;
        }

        .history-item:hover .del-btn { opacity: 1; }

        /* Toast Messages */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text);
            color: var(--bg);
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 0.9rem;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
            z-index: 100;
        }

        .toast.visible { opacity: 1; transform: translateX(-50%) translateY(-10px); }

        /* Responsiveness */
        @media (max-width: 900px) {
            .app {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr;
                overflow-y: auto;
            }
            .stage {
                padding: 15px;
                grid-row: 2;
            }
            .sidebar {
                grid-column: 1;
                grid-row: 3;
                border-left: none;
                border-top: 1px solid var(--border);
                max-height: none;
                overflow: visible;
            }
            body.theatre-mode .sidebar { display: none; }
            .live-timer { font-size: 2rem; }
        }
    </style>
</head>
<body>

<!-- Live Mode Strict Overlay -->
<div class="live-overlay" id="liveOverlay">
    <div class="live-indicator">
        <div class="live-icon"></div>
        LIVE CLASS IN PROGRESS
    </div>
    
    <div class="live-timer" id="liveTimer">00:00:00</div>
    
    <div class="live-message">
        This live class is currently in session. All controls are locked until completion.
        <br>Please focus on the lecture.
    </div>
    
    <div class="live-class-info">
        <div class="live-class-title" id="liveClassTitle">Loading...</div>
        <div>Video ID: <span id="liveVideoId">-</span></div>
        <div class="live-class-stats">
            <div>Progress: <span id="liveProgress">0%</span></div>
            <div>Remaining: <span id="liveRemaining">--:--</span></div>
        </div>
    </div>
    
    <div style="margin-top: 30px; font-size: 0.8rem; color: rgba(255,255,255,0.5);">
        ðŸ”’ System Locked â€¢ Do not refresh â€¢ Auto-save enabled
    </div>
</div>

<div class="app">
    <header>
        <div class="logo"><span>â—†</span> OmniPlayer v7.0</div>
        <div class="header-controls">
            <button class="live-btn" id="liveToggle">
                <span id="liveToggleText">Start Live Class [L]</span>
            </button>
            <button class="theatre-btn" id="theatreToggle">Theatre Mode [T]</button>
        </div>
    </header>

    <div class="stage">
        <div class="video-box">
            <div id="player"></div>
        </div>

        <div class="controls">
            <input type="text" id="urlInput" class="url-input" placeholder="YouTube URL or ID (Ctrl+V)">
            <button class="btn-main" id="playBtn">Play</button>
            <button class="btn-main btn-live" id="liveQuickBtn">Quick Live</button>
        </div>
        <div class="status-txt" id="status">
            Waiting for input...
            <span class="live-status" id="liveStatus">ðŸ”´ LIVE MODE ACTIVE</span>
        </div>
    </div>

    <aside class="sidebar">
        <div class="panel">
            <h3>Live Mode Settings</h3>
            <div class="live-settings">
                <div class="toggle">
                    <input type="checkbox" id="lock-keyboard" checked>
                    <label for="lock-keyboard">Lock keyboard shortcuts</label>
                </div>
                <div class="toggle">
                    <input type="checkbox" id="auto-fullscreen" checked>
                    <label for="auto-fullscreen">Auto fullscreen on start</label>
                </div>
                <div class="duration-input">
                    <input type="number" id="liveDuration" value="60" min="1" max="480">
                    <select id="durationUnit">
                        <option value="minutes">Minutes</option>
                        <option value="hours">Hours</option>
                    </select>
                </div>
                <button class="btn-apply" id="configureLiveBtn">Configure Live Session</button>
            </div>
        </div>

        <div class="panel">
            <h3>Playback Settings</h3>
            <div class="toggles">
                <label class="toggle"><input type="checkbox" id="set-auto" checked> Autoplay</label>
                <label class="toggle"><input type="checkbox" id="set-mute"> Mute Start</label>
                <label class="toggle"><input type="checkbox" id="set-loop"> Loop</label>
                <label class="toggle"><input type="checkbox" id="set-controls" checked> Show Controls</label>
                <label class="toggle"><input type="checkbox" id="set-ui"> Clean UI</label>
                <label class="toggle"><input type="checkbox" id="set-progress" checked> Show Progress</label>
            </div>
            <input type="number" id="set-start" class="override-input" placeholder="Force start time (seconds)...">
            <button class="btn-apply" id="applySettingsBtn">Apply Changes & Reload</button>
        </div>

        <div class="panel" style="padding-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
            <h3>History & Live Sessions</h3>
            <span style="font-size:0.7rem; color:var(--text-dim); cursor:pointer;" onclick="clearHistory()">CLEAR ALL</span>
        </div>

        <div class="history-wrapper" id="historyWrapper">
            <ul class="history-list" id="historyList"></ul>
        </div>
    </aside>
</div>

<div class="toast" id="toast"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
    // ====== ENHANCED STATE MANAGEMENT ======
    const STATE_KEY = 'omni_ultimate_db';
    const LIVE_MODE_KEY = 'omni_live_mode';
    
    let player = null;
    let saveTimer = null;
    let liveTimerInterval = null;
    let liveSession = null;
    
    // Load persistent data
    let db = JSON.parse(localStorage.getItem(STATE_KEY)) || { history: {}, liveSessions: [] };
    let currentId = null;

    // Elements
    const els = {
        input: document.getElementById('urlInput'),
        status: document.getElementById('status'),
        liveStatus: document.getElementById('liveStatus'),
        list: document.getElementById('historyList'),
        body: document.body,
        theatreBtn: document.getElementById('theatreToggle'),
        liveToggle: document.getElementById('liveToggle'),
        liveToggleText: document.getElementById('liveToggleText'),
        liveQuickBtn: document.getElementById('liveQuickBtn'),
        applyBtn: document.getElementById('applySettingsBtn'),
        configureLiveBtn: document.getElementById('configureLiveBtn'),
        historyWrapper: document.getElementById('historyWrapper'),
        liveOverlay: document.getElementById('liveOverlay'),
        liveTimer: document.getElementById('liveTimer'),
        liveClassTitle: document.getElementById('liveClassTitle'),
        liveVideoId: document.getElementById('liveVideoId'),
        liveProgress: document.getElementById('liveProgress'),
        liveRemaining: document.getElementById('liveRemaining'),
        settings: {
            auto: document.getElementById('set-auto'),
            mute: document.getElementById('set-mute'),
            loop: document.getElementById('set-loop'),
            controls: document.getElementById('set-controls'),
            ui: document.getElementById('set-ui'),
            start: document.getElementById('set-start'),
            progress: document.getElementById('set-progress'),
            lockKeyboard: document.getElementById('lock-keyboard'),
            autoFullscreen: document.getElementById('auto-fullscreen'),
            liveDuration: document.getElementById('liveDuration'),
            durationUnit: document.getElementById('durationUnit')
        }
    };

    // ====== LIVE MODE CORE FUNCTIONALITY ======
    function startLiveMode(durationMinutes = 60) {
        if (!currentId) {
            showToast("Load a video first before starting live mode");
            return;
        }

        liveSession = {
            id: currentId,
            startTime: Date.now(),
            duration: durationMinutes * 60 * 1000, // Convert to milliseconds
            endTime: Date.now() + (durationMinutes * 60 * 1000),
            progress: 0,
            paused: false,
            title: player.getVideoData ? player.getVideoData().title : `Live Session ${new Date().toLocaleTimeString()}`
        };

        // Save to localStorage
        localStorage.setItem(LIVE_MODE_KEY, JSON.stringify(liveSession));
        
        // Enable live mode UI
        els.body.classList.add('live-mode');
        els.liveToggle.classList.add('active');
        els.liveToggleText.textContent = "End Live Class [L]";
        els.liveStatus.classList.add('active');
        
        // Update live overlay
        els.liveVideoId.textContent = currentId;
        els.liveClassTitle.textContent = liveSession.title;
        
        // Start live timer
        startLiveTimer();
        
        // Lock controls if setting enabled
        if (els.settings.lockKeyboard.checked) {
            lockKeyboardControls();
        }
        
        // Auto fullscreen
        if (els.settings.autoFullscreen.checked && !document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(console.log);
        }
        
        // Add to live sessions history
        if (!db.liveSessions) db.liveSessions = [];
        db.liveSessions.unshift({
            id: currentId,
            title: liveSession.title,
            date: new Date().toISOString(),
            duration: durationMinutes,
            completed: false
        });
        persist();
        
        showToast("ðŸŽ¬ LIVE CLASS STARTED! Controls locked for " + durationMinutes + " minutes");
    }

    function endLiveMode(completed = true) {
        if (!liveSession) return;
        
        // Update completion status
        if (completed && db.liveSessions && db.liveSessions.length > 0) {
            db.liveSessions[0].completed = true;
            db.liveSessions[0].actualDuration = Math.floor((Date.now() - liveSession.startTime) / 1000 / 60);
        }
        
        // Disable live mode
        liveSession = null;
        localStorage.removeItem(LIVE_MODE_KEY);
        els.body.classList.remove('live-mode');
        els.liveToggle.classList.remove('active');
        els.liveToggleText.textContent = "Start Live Class [L]";
        els.liveStatus.classList.remove('active');
        
        // Clear intervals
        clearInterval(liveTimerInterval);
        
        // Unlock controls
        unlockKeyboardControls();
        
        // Exit fullscreen
        if (document.fullscreenElement) {
            document.exitFullscreen().catch(console.log);
        }
        
        showToast(completed ? "âœ… Live class completed!" : "â¹ï¸ Live class ended manually");
    }

    function startLiveTimer() {
        clearInterval(liveTimerInterval);
        
        liveTimerInterval = setInterval(() => {
            if (!liveSession) return;
            
            const now = Date.now();
            const elapsed = now - liveSession.startTime;
            const remaining = Math.max(0, liveSession.endTime - now);
            
            // Update timer display
            els.liveTimer.textContent = formatTime(elapsed);
            
            // Update progress
            const progressPercent = Math.min(100, (elapsed / liveSession.duration) * 100);
            els.liveProgress.textContent = Math.floor(progressPercent) + '%';
            els.liveRemaining.textContent = formatTime(remaining);
            
            // Auto-end when time is up
            if (now >= liveSession.endTime) {
                endLiveMode(true);
            }
            
            // Save live progress periodically
            liveSession.progress = progressPercent;
            localStorage.setItem(LIVE_MODE_KEY, JSON.stringify(liveSession));
            
        }, 1000);
    }

    function formatTime(ms) {
        const totalSeconds = Math.floor(ms / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        
        if (hours > 0) {
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function lockKeyboardControls() {
        const blockKeys = (e) => {
            // Allow only F5 (refresh) and F11 (fullscreen)
            if (e.key !== 'F5' && e.key !== 'F11' && !e.ctrlKey) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        };
        
        // Block keyboard
        document.addEventListener('keydown', blockKeys, true);
        document.addEventListener('keyup', blockKeys, true);
        document.addEventListener('keypress', blockKeys, true);
        
        // Block right click
        document.addEventListener('contextmenu', (e) => e.preventDefault(), true);
    }

    function unlockKeyboardControls() {
        // Remove event listeners by cloning and replacing
        document.removeEventListener('keydown', lockKeyboardControls, true);
        document.removeEventListener('keyup', lockKeyboardControls, true);
        document.removeEventListener('keypress', lockKeyboardControls, true);
        document.removeEventListener('contextmenu', (e) => e.preventDefault(), true);
    }

    // ====== ENHANCED CORE FUNCTIONS ======
    function onYouTubeIframeAPIReady() {
        // Check for saved live mode on startup
        const savedLiveSession = localStorage.getItem(LIVE_MODE_KEY);
        if (savedLiveSession) {
            try {
                liveSession = JSON.parse(savedLiveSession);
                
                // Check if live session is still valid
                if (Date.now() < liveSession.endTime) {
                    // Resume live mode
                    currentId = liveSession.id;
                    initVideo(currentId);
                    
                    // Wait for player to load, then enable live mode
                    setTimeout(() => {
                        els.body.classList.add('live-mode');
                        els.liveToggle.classList.add('active');
                        els.liveToggleText.textContent = "End Live Class [L]";
                        els.liveStatus.classList.add('active');
                        startLiveTimer();
                        showToast("ðŸ”´ RESUMED LIVE CLASS - Controls locked");
                    }, 2000);
                } else {
                    // Session expired
                    localStorage.removeItem(LIVE_MODE_KEY);
                    showToast("Previous live session expired");
                }
            } catch (e) {
                console.error("Error loading live session:", e);
            }
        }
        
        showToast("System ready with Live Mode support");
        updateProgressVisibility();
    }

    function updateProgressVisibility() {
        if (els.settings.progress.checked) {
            els.historyWrapper.classList.remove('no-progress');
        } else {
            els.historyWrapper.classList.add('no-progress');
        }
    }

    function parseId(url) {
        if (!url) return null;
        const match = url.match(/(?:youtu\.be\/|v\/|embed\/|shorts\/|watch\?v=|&v=)([^#&?]*)/);
        return (match && match[1].length === 11) ? match[1] : (url.length === 11 ? url : null);
    }

    function initVideo(forceId = null) {
        const id = forceId || currentId || parseId(els.input.value);
        
        if (!id) {
            if (els.input.value.trim() !== "") showToast("Invalid URL or ID");
            return;
        }

        currentId = id;
        
        // Start time calculation
        let startTime = 0;
        const historyEntry = db.history[id];
        
        if (els.settings.start.value) {
            startTime = parseInt(els.settings.start.value);
            els.status.innerText = `Manual start: ${fmtTime(startTime)}`;
        } 
        else if (historyEntry && historyEntry.time > 10) {
            startTime = Math.floor(historyEntry.time);
            els.status.innerText = `Resuming from: ${fmtTime(startTime)}`;
        } else {
            els.status.innerText = `Starting new video`;
        }

        // Player setup
        if (player) {
            player.destroy();
            clearInterval(saveTimer);
        }

        const vars = {
            playsinline: 1,
            rel: 0,
            fs: 1,
            start: startTime,
            controls: els.settings.controls.checked ? 1 : 0,
            modestbranding: els.settings.ui.checked ? 1 : 0,
            loop: els.settings.loop.checked ? 1 : 0,
        };
        if (vars.loop) vars.playlist = id;

        player = new YT.Player('player', {
            videoId: id,
            width: '100%',
            height: '100%',
            playerVars: vars,
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange,
                'onError': (e) => showToast(`Error ${e.data}`)
            }
        });

        if (!forceId && !currentId) els.input.value = ""; 
        renderHistory();
    }

    function onPlayerReady(e) {
        if (els.settings.auto.checked) {
            if (els.settings.mute.checked) e.target.mute();
            e.target.playVideo();
        }
    }

    function onPlayerStateChange(e) {
        if (e.data === YT.PlayerState.PLAYING) {
            startSaving();
        } else {
            clearInterval(saveTimer);
        }
    }

    function startSaving() {
        clearInterval(saveTimer);
        saveTimer = setInterval(() => {
            if (!player || !player.getCurrentTime) return;
            const t = player.getCurrentTime();
            const d = player.getDuration();
            
            if (t < 1 && d > 0) return;

            db.history[currentId] = {
                id: currentId,
                time: t,
                duration: d,
                ts: Date.now(),
                title: player.getVideoData ? player.getVideoData().title : currentId
            };
            persist();
        }, 3000);
    }

    function persist() {
        localStorage.setItem(STATE_KEY, JSON.stringify(db));
    }

    // ====== ENHANCED HISTORY RENDER ======
    function fmtTime(s) {
        if (!s) return "0:00";
        const date = new Date(0);
        date.setSeconds(s);
        return date.toISOString().substr(11, 8).replace(/^00:/, '');
    }

    function renderHistory() {
        const list = els.list;
        list.innerHTML = '';
        
        // Combine regular history and live sessions
        const regularHistory = Object.values(db.history).sort((a, b) => b.ts - a.ts);
        const liveSessions = db.liveSessions || [];
        
        if (regularHistory.length === 0 && liveSessions.length === 0) {
            list.innerHTML = '<li style="padding:20px; text-align:center; color:var(--text-dim)">No history yet</li>';
            return;
        }

        // Add live sessions first
        liveSessions.forEach(session => {
            const li = document.createElement('li');
            li.className = `history-item live`;
            li.onclick = () => {
                els.input.value = `https://youtu.be/${session.id}`;
                initVideo(session.id);
            };

            li.innerHTML = `
                <div class="thumb">
                    <img src="https://img.youtube.com/vi/${session.id}/mqdefault.jpg" loading="lazy">
                    <div class="progress-bar"><div class="progress-fill" style="width:100%"></div></div>
                </div>
                <div class="info">
                    <div class="title">${session.title || session.id}</div>
                    <div class="meta">
                        <span class="live-badge">LIVE</span>
                        <span>${session.duration} min â€¢ ${new Date(session.date).toLocaleDateString()}</span>
                    </div>
                </div>
            `;
            list.appendChild(li);
        });

        // Add regular history
        regularHistory.forEach(item => {
            const pct = item.duration ? (item.time / item.duration) * 100 : 0;
            const li = document.createElement('li');
            li.className = `history-item ${currentId === item.id ? 'active' : ''}`;
            li.onclick = () => initVideo(item.id);

            li.innerHTML = `
                <div class="thumb">
                    <img src="https://img.youtube.com/vi/${item.id}/mqdefault.jpg" loading="lazy">
                    <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
                </div>
                <div class="info">
                    <div class="title">${item.title || item.id}</div>
                    <div class="meta">${fmtTime(item.time)} / ${fmtTime(item.duration)} â€¢ ${new Date(item.ts).toLocaleDateString()}</div>
                </div>
                <button class="del-btn" onclick="delHistory(event, '${item.id}')">âœ•</button>
            `;
            list.appendChild(li);
        });
    }

    function delHistory(e, id) {
        e.stopPropagation();
        delete db.history[id];
        persist();
        renderHistory();
    }

    function clearHistory() {
        if (confirm("Clear all history and live sessions?")) {
            db.history = {};
            db.liveSessions = [];
            persist();
            renderHistory();
        }
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('visible');
        setTimeout(() => t.classList.remove('visible'), 2500);
    }

    // ====== THEATRE MODE ======
    let isTheatre = false;
    function toggleTheatre() {
        isTheatre = !isTheatre;
        els.body.classList.toggle('theatre-mode', isTheatre);
        els.theatreBtn.innerText = isTheatre ? "Exit Theatre [T]" : "Theatre Mode [T]";
        showToast(isTheatre ? "Theatre mode ON" : "Theatre mode OFF");
    }

    // ====== EVENT LISTENERS ======
    document.getElementById('playBtn').addEventListener('click', () => {
        const id = parseId(els.input.value);
        if (id) initVideo(id);
        else showToast("Please paste a valid URL");
    });

    els.liveQuickBtn.addEventListener('click', () => {
        const duration = parseInt(els.settings.liveDuration.value);
        const unit = els.settings.durationUnit.value;
        const totalMinutes = unit === 'hours' ? duration * 60 : duration;
        startLiveMode(totalMinutes);
    });

    els.liveToggle.addEventListener('click', () => {
        if (liveSession) {
            if (confirm("End live class? This will unlock all controls.")) {
                endLiveMode(false);
            }
        } else {
            const duration = parseInt(els.settings.liveDuration.value);
            const unit = els.settings.durationUnit.value;
            const totalMinutes = unit === 'hours' ? duration * 60 : duration;
            startLiveMode(totalMinutes);
        }
    });

    els.configureLiveBtn.addEventListener('click', () => {
        const duration = parseInt(els.settings.liveDuration.value);
        const unit = els.settings.durationUnit.value;
        const totalMinutes = unit === 'hours' ? duration * 60 : duration;
        showToast(`Live session configured for ${totalMinutes} minutes`);
    });

    els.applyBtn.addEventListener('click', () => {
        if (currentId) {
            initVideo(currentId);
            showToast("Settings applied and player reloaded");
        } else {
            showToast("No video currently loaded");
        }
    });

    els.settings.progress.addEventListener('change', updateProgressVisibility);

    els.input.addEventListener('keypress', e => {
        if (e.key === 'Enter') {
            const id = parseId(els.input.value);
            if (id) initVideo(id);
        }
    });

    els.theatreBtn.addEventListener('click', toggleTheatre);

    // ====== KEYBOARD SHORTCUTS ======
    document.addEventListener('keydown', (e) => {
        // Don't trigger if in live mode and keyboard locked
        if (liveSession && els.settings.lockKeyboard.checked) return;
        
        if (e.key.toLowerCase() === 't' && document.activeElement.tagName !== 'INPUT') {
            toggleTheatre();
        }
        
        if (e.key.toLowerCase() === 'l' && document.activeElement.tagName !== 'INPUT') {
            if (liveSession) {
                endLiveMode(false);
            } else if (currentId) {
                const duration = parseInt(els.settings.liveDuration.value);
                const unit = els.settings.durationUnit.value;
                const totalMinutes = unit === 'hours' ? duration * 60 : duration;
                startLiveMode(totalMinutes);
            }
        }
        
        if (e.key === 'F5' && liveSession) {
            e.preventDefault();
            showToast("Live mode active - refresh blocked");
            return false;
        }
    });

    // ====== INITIALIZATION ======
    renderHistory();
    
    // Handle page refresh warning
    window.addEventListener('beforeunload', (e) => {
        if (liveSession) {
            e.preventDefault();
            e.returnValue = 'Live class is in progress! Are you sure you want to leave? Your progress will be saved.';
        }
    });
</script>

</body>
</html>
