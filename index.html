<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniPlayer Pro: Continue Watching</title>
    <style>
        :root {
            --primary: #ff0000;
            --bg: #f9f9f9;
            --surface: #ffffff;
            --text: #333333;
            --border: #e0e0e0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --radius: 12px;
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --prog-bar-bg: #ddd;
            --prog-bar-fill: #ff0000;
        }

        [data-theme="dark"] {
            --bg: #0f0f0f;
            --surface: #1e1e1e;
            --text: #f0f0f0;
            --border: #333333;
            --prog-bar-bg: #444;
        }

        * { box-sizing: border-box; outline: none; }
        body { margin: 0; padding: 0; font-family: var(--font); background: var(--bg); color: var(--text); transition: background 0.3s, color 0.3s; }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; display: grid; grid-template-columns: 1fr 300px; gap: 20px; min-height: 100vh; }
        
        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }

        header { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        h1 span { color: var(--primary); }
        
        .theme-toggle { background: none; border: none; cursor: pointer; font-size: 1.5rem; padding: 5px; }

        .player-section { display: flex; flex-direction: column; gap: 20px; }
        
        /* Video Area */
        .video-wrapper {
            position: relative; padding-bottom: 56.25%; height: 0; background: #000;
            border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow);
        }
        
        /* The div that YT API replaces */
        #player { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* Input Area */
        .input-group { display: flex; gap: 10px; background: var(--surface); padding: 15px; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow); }
        .url-input { flex: 1; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); }
        .btn { padding: 0 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; color: white; background: var(--primary); }
        .btn:hover { filter: brightness(1.1); }
        .btn-sec { background: var(--border); color: var(--text); }
        
        /* Sidebar */
        .sidebar { display: flex; flex-direction: column; gap: 20px; }
        .panel { background: var(--surface); border-radius: var(--radius); padding: 20px; border: 1px solid var(--border); box-shadow: var(--shadow); }
        .panel h3 { margin: 0 0 15px 0; font-size: 1.1rem; border-bottom: 1px solid var(--border); padding-bottom: 10px; display: flex; justify-content: space-between; }

        /* Settings Grid */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .setting-item { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; }
        .setting-item.full { grid-column: 1 / -1; }
        input[type="checkbox"] { accent-color: var(--primary); cursor: pointer; }
        input[type="number"] { width: 100%; padding: 5px; background: var(--bg); color: var(--text); border: 1px solid var(--border); border-radius: 4px; }

        /* History */
        .history-list { list-style: none; padding: 0; margin: 0; max-height: 400px; overflow-y: auto; }
        .history-item { padding: 10px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; gap: 10px; align-items: center; transition: 0.2s; position: relative; }
        .history-item:hover { background: var(--bg); }
        .history-thumb { width: 80px; height: 60px; background: #000; object-fit: cover; border-radius: 4px; flex-shrink: 0; }
        .history-info { flex: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
        .history-title { font-size: 0.85rem; font-weight: 600; margin-bottom: 4px; }
        .history-meta { font-size: 0.75rem; color: #888; display: flex; justify-content: space-between; }
        .history-progress-bg { height: 4px; background: var(--prog-bar-bg); width: 100%; margin-top: 6px; border-radius: 2px; overflow: hidden; }
        .history-progress-fill { height: 100%; background: var(--prog-bar-fill); width: 0%; transition: width 0.3s; }
        .btn-del { color: #ff4444; font-size: 1.2rem; padding: 0 5px; }

        /* Status Toast */
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 999; }
        .toast.show { opacity: 1; bottom: 40px; }
        
        /* Live Indicator */
        .watching-now { border-left: 4px solid var(--primary); background: var(--bg); }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1><span>â–¶</span> OmniPlayer Pro</h1>
        <button class="theme-toggle" id="themeBtn">ðŸŒ™</button>
    </header>

    <main class="player-section">
        <div class="video-wrapper">
            <div id="player"></div>
        </div>

        <div class="input-group">
            <input type="text" id="urlInput" class="url-input" placeholder="Paste YouTube Link or ID">
            <button class="btn" id="loadBtn">Play</button>
        </div>
        
        <div class="panel">
            <h3>Now Playing Info</h3>
            <div id="statusDisplay" style="font-size: 0.9rem; color: #888;">Waiting for video...</div>
        </div>
    </main>

    <aside class="sidebar">
        <div class="panel">
            <h3>Settings <button class="btn btn-sec" style="padding:2px 8px; font-size:0.7rem;" onclick="resetDefaults()">Reset</button></h3>
            <div class="settings-grid">
                <div class="setting-item"><input type="checkbox" id="autoplay" checked><label for="autoplay">Autoplay</label></div>
                <div class="setting-item"><input type="checkbox" id="loop"><label for="loop">Loop</label></div>
                <div class="setting-item"><input type="checkbox" id="controls" checked><label for="controls">Controls</label></div>
                <div class="setting-item"><input type="checkbox" id="modest"><label for="modest">Clean UI</label></div>
                <div class="setting-item full">
                    <label>Force Start (Seconds)</label>
                    <input type="number" id="startOverride" placeholder="Leave empty to resume history">
                </div>
            </div>
            <button class="btn btn-sec" style="width:100%; margin-top:10px;" id="applyBtn">Apply Settings (Reload)</button>
        </div>

        <div class="panel">
            <h3>History <button class="btn btn-sec" style="padding:2px 8px; font-size:0.7rem;" onclick="wipeHistory()">Clear</button></h3>
            <ul class="history-list" id="historyList"></ul>
        </div>
    </aside>
</div>

<div class="toast" id="toast">Message</div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
    // --- Global State ---
    let player;
    let saveInterval;
    let currentState = {
        videoId: '',
        history: JSON.parse(localStorage.getItem('yt_omni_pro_history')) || {}
    };

    const els = {
        input: document.getElementById('urlInput'),
        status: document.getElementById('statusDisplay'),
        historyList: document.getElementById('historyList'),
        settings: {
            autoplay: document.getElementById('autoplay'),
            loop: document.getElementById('loop'),
            controls: document.getElementById('controls'),
            modest: document.getElementById('modest'),
            start: document.getElementById('startOverride')
        }
    };

    // --- API Ready ---
    function onYouTubeIframeAPIReady() {
        // Placeholder player, waiting for user input
        showToast("Player API Ready");
    }

    // --- Core Player Logic ---
    function loadVideo(forceId = null) {
        let inputVal = els.input.value.trim();
        let videoId = forceId || extractVideoId(inputVal);

        if (!videoId) {
            showToast("Invalid Video ID");
            return;
        }

        currentState.videoId = videoId;

        // 1. Determine Start Time
        let startTime = 0;
        
        // Priority 1: User forced start time setting
        if (els.settings.start.value) {
            startTime = parseInt(els.settings.start.value);
            els.status.innerHTML = `Starting at forced time: ${formatTime(startTime)}`;
        } 
        // Priority 2: Resume from history
        else if (currentState.history[videoId] && currentState.history[videoId].time > 5) {
            // >5 check prevents resuming intro logos
            startTime = Math.floor(currentState.history[videoId].time);
            els.status.innerHTML = `Resuming from ${formatTime(startTime)}`;
        } else {
            els.status.innerHTML = `Starting from beginning`;
        }

        // 2. Destroy old player if exists
        if (player) {
            player.destroy();
            clearInterval(saveInterval);
        }

        // 3. Create new player
        const playerVars = {
            'playsinline': 1,
            'controls': els.settings.controls.checked ? 1 : 0,
            'rel': 0,
            'fs': 1,
            'modestbranding': els.settings.modest.checked ? 1 : 0,
            'start': startTime,
            'loop': els.settings.loop.checked ? 1 : 0,
        };

        // If loop is on, playlist param is needed
        if (els.settings.loop.checked) {
            playerVars['playlist'] = videoId;
        }

        player = new YT.Player('player', {
            height: '100%',
            width: '100%',
            videoId: videoId,
            playerVars: playerVars,
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange,
                'onError': (e) => showToast("Video Error: " + e.data)
            }
        });

        updateHistoryEntry(videoId, startTime); // Initial save
        els.input.value = `https://youtu.be/${videoId}`;
    }

    function onPlayerReady(event) {
        if (els.settings.autoplay.checked) {
            event.target.playVideo();
        }
        
        // Start the save loop
        startSavingProgress();
    }

    function onPlayerStateChange(event) {
        // 1 = Playing
        if (event.data == YT.PlayerState.PLAYING) {
            startSavingProgress();
        } else {
            clearInterval(saveInterval);
        }
    }

    // --- Save Logic ---
    function startSavingProgress() {
        clearInterval(saveInterval);
        saveInterval = setInterval(() => {
            if (player && player.getCurrentTime) {
                const currentTime = player.getCurrentTime();
                const duration = player.getDuration();
                
                if (currentTime > 0 && duration > 0) {
                    saveToHistory(currentState.videoId, currentTime, duration);
                }
            }
        }, 5000); // Save every 5 seconds
    }

    function saveToHistory(id, time, duration) {
        if (!currentState.history[id]) currentState.history[id] = {};
        
        currentState.history[id] = {
            id: id,
            time: time,
            duration: duration,
            lastPlayed: Date.now()
        };
        
        localStorage.setItem('yt_omni_pro_history', JSON.stringify(currentState.history));
        renderHistory();
    }

    // --- Helper Logic ---
    function extractVideoId(url) {
        if(!url) return null;
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        if (match && match[2].length == 11) return match[2];
        if (url.length === 11) return url; 
        return null;
    }

    function formatTime(seconds) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        return (h > 0 ? h + ":" : "") + (m < 10 && h > 0 ? "0" : "") + m + ":" + (s < 10 ? "0" : "") + s;
    }

    // --- UI/History Rendering ---
    function renderHistory() {
        const list = els.historyList;
        list.innerHTML = '';

        // Convert object to array and sort by lastPlayed (desc)
        const sorted = Object.values(currentState.history).sort((a, b) => b.lastPlayed - a.lastPlayed);

        if (sorted.length === 0) {
            list.innerHTML = '<li style="padding:10px;text-align:center;color:#888">No history yet.</li>';
            return;
        }

        sorted.forEach(item => {
            const percent = item.duration ? (item.time / item.duration) * 100 : 0;
            const li = document.createElement('li');
            li.className = 'history-item';
            if(item.id === currentState.videoId) li.classList.add('watching-now');
            
            li.onclick = () => loadVideo(item.id);

            li.innerHTML = `
                <img src="https://img.youtube.com/vi/${item.id}/mqdefault.jpg" class="history-thumb">
                <div class="history-info">
                    <div class="history-title">Video ID: ${item.id}</div>
                    <div class="history-meta">
                        <span>${formatTime(item.time)} / ${formatTime(item.duration || 0)}</span>
                        <span>${new Date(item.lastPlayed).toLocaleDateString()}</span>
                    </div>
                    <div class="history-progress-bg">
                        <div class="history-progress-fill" style="width: ${percent}%"></div>
                    </div>
                </div>
                <div class="btn-del" onclick="deleteHistory(event, '${item.id}')">&times;</div>
            `;
            list.appendChild(li);
        });
    }

    function updateHistoryEntry(id, startTime) {
        // Just ensures the list highlights the current video immediately on load
        saveToHistory(id, startTime, 0); 
    }

    function deleteHistory(e, id) {
        e.stopPropagation();
        delete currentState.history[id];
        localStorage.setItem('yt_omni_pro_history', JSON.stringify(currentState.history));
        renderHistory();
    }

    function wipeHistory() {
        if(confirm("Delete all history?")) {
            currentState.history = {};
            localStorage.removeItem('yt_omni_pro_history');
            renderHistory();
        }
    }

    // --- Listeners ---
    document.getElementById('loadBtn').addEventListener('click', () => loadVideo());
    document.getElementById('applyBtn').addEventListener('click', () => {
        if(currentState.videoId) loadVideo(currentState.videoId);
    });
    
    document.getElementById('themeBtn').addEventListener('click', () => {
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
    });

    els.input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') loadVideo();
    });

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    function resetDefaults() {
        els.settings.autoplay.checked = true;
        els.settings.controls.checked = true;
        els.settings.loop.checked = false;
        els.settings.modest.checked = false;
        els.settings.start.value = '';
        showToast("Settings Reset");
    }

    // Initial Render
    renderHistory();
</script>

</body>
</html>
