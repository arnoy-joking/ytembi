<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OmniPlayer Pro: Advanced YouTube Player with AI Features</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root {
      /* Extended Color Palette */
      --primary: #ff0000;
      --primary-dark: #cc0000;
      --primary-light: #ff3333;
      --secondary: #3b82f6;
      --secondary-dark: #1d4ed8;
      --accent: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #06b6d4;
      
      /* Theme Variables */
      --bg-light: #ffffff;
      --surface-light: #f8fafc;
      --card-light: #ffffff;
      --text-light: #111827;
      --text-secondary-light: #6b7280;
      --border-light: #e5e7eb;
      --shadow-light: 0 4px 24px rgba(0, 0, 0, 0.08);
      --radius: 20px;
      --radius-sm: 12px;
      --radius-lg: 28px;
      --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --prog-bar-bg: #e5e7eb;
      --prog-bar-fill: var(--primary);
      
      /* Animation */
      --transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    [data-theme='dark'] {
      --bg: #0a0a0a;
      --surface: #151515;
      --card: #1e1e1e;
      --text: #f9fafb;
      --text-secondary: #9ca3af;
      --border: #374151;
      --shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
      --prog-bar-bg: #4b5563;
    }

    [data-theme='midnight'] {
      --bg: #0f172a;
      --surface: #1e293b;
      --card: #334155;
      --text: #f1f5f9;
      --text-secondary: #cbd5e1;
      --border: #475569;
      --shadow: 0 8px 30px rgba(15, 23, 42, 0.7);
      --prog-bar-bg: #475569;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font);
      background: var(--bg, var(--bg-light));
      color: var(--text, var(--text-light));
      transition: background var(--transition), color var(--transition);
      min-height: 100vh;
      padding: 0;
      overflow-x: hidden;
    }

    .container {
      max-width: 1440px;
      margin: 0 auto;
      padding: 24px;
      display: grid;
      grid-template-columns: minmax(0, 1fr) 380px;
      gap: 32px;
      min-height: 100vh;
    }

    @media (max-width: 1100px) {
      .container {
        grid-template-columns: 1fr;
        gap: 24px;
        padding: 16px;
      }
    }

    /* Header with Enhanced UI */
    header {
      grid-column: 1 / -1;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border, var(--border-light));
    }

    .logo-area {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    h1 {
      font-weight: 900;
      font-size: 2.2rem;
      display: flex;
      align-items: center;
      gap: 12px;
      background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      letter-spacing: -0.5px;
    }

    .version-badge {
      background: var(--primary);
      color: white;
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 20px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .header-controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .theme-selector {
      position: relative;
    }

    .theme-btn {
      background: var(--surface, var(--surface-light));
      border: 1px solid var(--border, var(--border-light));
      color: var(--text, var(--text-light));
      padding: 10px 16px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      font-size: 0.9rem;
      transition: all var(--transition);
    }

    .theme-btn:hover {
      background: var(--card, var(--card-light));
      transform: translateY(-2px);
      box-shadow: var(--shadow, var(--shadow-light));
    }

    .theme-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      background: var(--surface, var(--surface-light));
      border: 1px solid var(--border, var(--border-light));
      border-radius: var(--radius-sm);
      padding: 8px;
      display: none;
      flex-direction: column;
      min-width: 180px;
      z-index: 100;
      box-shadow: var(--shadow, var(--shadow-light));
    }

    .theme-dropdown.show {
      display: flex;
    }

    .theme-option {
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background var(--transition);
    }

    .theme-option:hover {
      background: var(--card, var(--card-light));
    }

    .theme-option.active {
      background: rgba(255, 0, 0, 0.1);
      color: var(--primary);
    }

    .theme-icon {
      width: 20px;
      text-align: center;
    }

    .export-btn, .import-btn {
      padding: 10px 18px;
      border-radius: var(--radius-sm);
      font-weight: 600;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all var(--transition);
    }

    .export-btn {
      background: var(--secondary);
      color: white;
      border: none;
    }

    .export-btn:hover {
      background: var(--secondary-dark);
      transform: translateY(-2px);
    }

    .import-btn {
      background: transparent;
      border: 2px dashed var(--border, var(--border-light));
      color: var(--text, var(--text-light));
    }

    .import-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    /* Main Player Area */
    .player-section {
      display: flex;
      flex-direction: column;
      gap: 32px;
    }

    /* Enhanced Video Wrapper */
    .video-wrapper {
      position: relative;
      padding-bottom: 56.25%;
      height: 0;
      background: #000;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow, var(--shadow-light));
      transition: transform 0.3s ease;
    }

    .video-wrapper:hover {
      transform: translateY(-4px);
    }

    #player {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: var(--radius);
    }

    .video-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      padding: 24px;
      background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 50%);
      border-radius: var(--radius);
      z-index: 5;
      opacity: 0;
      transition: opacity var(--transition);
    }

    .video-wrapper:hover .video-overlay {
      opacity: 1;
    }

    .video-info {
      color: white;
    }

    .video-title {
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 8px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }

    .video-channel {
      font-size: 1rem;
      opacity: 0.9;
    }

    /* Enhanced Input Area */
    .input-group {
      display: flex;
      gap: 12px;
      background: var(--surface, var(--surface-light));
      padding: 20px;
      border-radius: var(--radius);
      border: 1px solid var(--border, var(--border-light));
      box-shadow: var(--shadow, var(--shadow-light));
    }

    .url-input {
      flex: 1;
      padding: 16px 20px;
      border: 2px solid var(--border, var(--border-light));
      border-radius: var(--radius-sm);
      background: var(--bg, var(--bg-light));
      color: var(--text, var(--text-light));
      font-size: 1rem;
      transition: all var(--transition);
      font-family: var(--font);
    }

    .url-input:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(255, 0, 0, 0.1);
    }

    .input-actions {
      display: flex;
      gap: 12px;
    }

    .btn {
      padding: 0 28px;
      border: none;
      border-radius: var(--radius-sm);
      font-weight: 700;
      cursor: pointer;
      color: white;
      background: var(--primary);
      font-size: 1rem;
      transition: all var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      letter-spacing: 0.3px;
    }

    .btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 0, 0, 0.2);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-sec {
      background: var(--card, var(--card-light));
      color: var(--text, var(--text-light));
      border: 1px solid var(--border, var(--border-light));
    }

    .btn-sec:hover {
      background: var(--surface, var(--surface-light));
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-2px);
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 0.85rem;
    }

    /* Now Playing Panel with Enhanced Info */
    .now-playing-panel {
      background: var(--surface, var(--surface-light));
      border-radius: var(--radius);
      padding: 24px;
      border: 1px solid var(--border, var(--border-light));
      box-shadow: var(--shadow, var(--shadow-light));
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    h3 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .panel-actions {
      display: flex;
      gap: 8px;
    }

    .video-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px;
      background: var(--card, var(--card-light));
      border-radius: var(--radius-sm);
      transition: transform var(--transition);
    }

    .stat-item:hover {
      transform: translateY(-3px);
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 0.85rem;
      color: var(--text-secondary, var(--text-secondary-light));
      text-align: center;
    }

    .video-controls-quick {
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .quick-control-btn {
      flex: 1;
      padding: 12px;
      border-radius: var(--radius-sm);
      background: var(--card, var(--card-light));
      border: 1px solid var(--border, var(--border-light));
      color: var(--text, var(--text-light));
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      transition: all var(--transition);
    }

    .quick-control-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .quick-control-btn i {
      font-size: 1.2rem;
    }

    .quick-control-label {
      font-size: 0.8rem;
      font-weight: 600;
    }

    /* Sidebar Enhancements */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 32px;
    }

    .panel {
      background: var(--surface, var(--surface-light));
      border-radius: var(--radius);
      padding: 24px;
      border: 1px solid var(--border, var(--border-light));
      box-shadow: var(--shadow, var(--shadow-light));
    }

    /* Enhanced Settings Grid */
    .settings-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .setting-item {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 0.95rem;
      padding: 12px;
      border-radius: var(--radius-sm);
      transition: background var(--transition);
    }

    .setting-item:hover {
      background: var(--card, var(--card-light));
    }

    .setting-item.full {
      grid-column: 1 / -1;
    }

    input[type='checkbox'] {
      accent-color: var(--primary);
      cursor: pointer;
      width: 20px;
      height: 20px;
    }

    input[type='range'] {
      width: 100%;
      accent-color: var(--primary);
    }

    input[type='number'] {
      width: 100%;
      padding: 12px;
      background: var(--card, var(--card-light));
      color: var(--text, var(--text-light));
      border: 1px solid var(--border, var(--border-light));
      border-radius: var(--radius-sm);
      font-size: 0.95rem;
      transition: border-color var(--transition);
    }

    input[type='number']:focus {
      border-color: var(--primary);
      outline: none;
    }

    .range-with-value {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .range-value {
      min-width: 40px;
      text-align: center;
      font-weight: 600;
      color: var(--primary);
    }

    /* Enhanced History List */
    .history-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 500px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .history-item {
      padding: 16px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      display: flex;
      gap: 16px;
      align-items: center;
      transition: all var(--transition);
      position: relative;
      border: 1px solid transparent;
      background: var(--card, var(--card-light));
    }

    .history-item:hover {
      transform: translateX(4px);
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(255, 0, 0, 0.1);
    }

    .history-item.watching-now {
      border-left: 6px solid var(--primary);
      background: rgba(255, 0, 0, 0.05);
    }

    [data-theme='dark'] .history-item.watching-now,
    [data-theme='midnight'] .history-item.watching-now {
      background: rgba(255, 0, 0, 0.1);
    }

    .history-thumb {
      width: 100px;
      height: 75px;
      object-fit: cover;
      border-radius: 10px;
      flex-shrink: 0;
      background: #000;
    }

    .history-info {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-width: 0;
    }

    .history-title {
      font-size: 0.95rem;
      font-weight: 700;
      margin-bottom: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .history-meta {
      font-size: 0.8rem;
      color: var(--text-secondary, var(--text-secondary-light));
      display: flex;
      justify-content: space-between;
      white-space: nowrap;
    }

    .history-progress-bg {
      height: 6px;
      background: var(--prog-bar-bg);
      width: 100%;
      margin-top: 10px;
      border-radius: 3px;
      overflow: hidden;
    }

    .history-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      width: 0%;
      transition: width 0.5s ease;
      border-radius: 3px;
    }

    .history-actions {
      display: flex;
      gap: 8px;
      opacity: 0;
      transition: opacity var(--transition);
    }

    .history-item:hover .history-actions {
      opacity: 1;
    }

    .btn-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all var(--transition);
      background: var(--surface, var(--surface-light));
      color: var(--text, var(--text-light));
      border: 1px solid var(--border, var(--border-light));
    }

    .btn-icon:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .btn-icon.danger:hover {
      background: var(--danger);
      border-color: var(--danger);
    }

    /* Playlist Panel */
    .playlist-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: var(--radius-sm);
      cursor: move;
      transition: background var(--transition);
    }

    .playlist-item:hover {
      background: var(--card, var(--card-light));
    }

    .playlist-item.active {
      background: rgba(255, 0, 0, 0.1);
      border-left: 4px solid var(--primary);
    }

    .drag-handle {
      cursor: move;
      color: var(--text-secondary, var(--text-secondary-light));
    }

    /* Enhanced Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--surface, var(--surface-light));
      color: var(--text, var(--text-light));
      padding: 16px 28px;
      border-radius: var(--radius);
      opacity: 0;
      transition: opacity 0.3s, bottom 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      pointer-events: none;
      z-index: 1000;
      font-size: 0.95rem;
      font-weight: 600;
      box-shadow: var(--shadow, var(--shadow-light));
      border: 1px solid var(--border, var(--border-light));
      display: flex;
      align-items: center;
      gap: 12px;
      max-width: 90%;
    }

    .toast.show {
      opacity: 1;
      bottom: 40px;
    }

    .toast.success {
      border-left: 6px solid var(--accent);
    }

    .toast.error {
      border-left: 6px solid var(--danger);
    }

    .toast.warning {
      border-left: 6px solid var(--warning);
    }

    .toast.info {
      border-left: 6px solid var(--info);
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--transition);
    }

    .modal.show {
      opacity: 1;
      pointer-events: all;
    }

    .modal-content {
      background: var(--surface, var(--surface-light));
      border-radius: var(--radius);
      padding: 32px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border, var(--border-light));
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 800;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-secondary, var(--text-secondary-light));
      transition: color var(--transition);
    }

    .modal-close:hover {
      color: var(--danger);
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: var(--card, var(--card-light));
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }

    /* Loading Animation */
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--border, var(--border-light));
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Utility Classes */
    .hidden {
      display: none !important;
    }

    .text-center {
      text-align: center;
    }

    .mb-2 {
      margin-bottom: 8px;
    }

    .mb-4 {
      margin-bottom: 16px;
    }

    .mt-2 {
      margin-top: 8px;
    }

    .mt-4 {
      margin-top: 16px;
    }

    .gap-2 {
      gap: 8px;
    }

    .gap-4 {
      gap: 16px;
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
      h1 {
        font-size: 1.8rem;
      }
      
      .video-stats {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .settings-grid {
        grid-template-columns: 1fr;
      }
      
      .input-actions {
        flex-direction: column;
      }
      
      .btn {
        padding: 12px;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 12px;
      }
      
      .panel {
        padding: 20px;
      }
      
      .video-stats {
        grid-template-columns: 1fr;
      }
      
      .history-item {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .history-thumb {
        width: 100%;
        height: 120px;
      }
      
      .history-actions {
        align-self: flex-end;
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo-area">
        <h1><i class="fas fa-play-circle"></i> OmniPlayer Pro</h1>
        <span class="version-badge">v3.0</span>
      </div>
      
      <div class="header-controls">
        <div class="theme-selector">
          <button class="theme-btn" id="themeBtn">
            <i class="fas fa-palette"></i> Theme
          </button>
          <div class="theme-dropdown" id="themeDropdown">
            <div class="theme-option active" data-theme="light">
              <span class="theme-icon"><i class="fas fa-sun"></i></span>
              <span>Light</span>
            </div>
            <div class="theme-option" data-theme="dark">
              <span class="theme-icon"><i class="fas fa-moon"></i></span>
              <span>Dark</span>
            </div>
            <div class="theme-option" data-theme="midnight">
              <span class="theme-icon"><i class="fas fa-stars"></i></span>
              <span>Midnight</span>
            </div>
          </div>
        </div>
        
        <button class="import-btn" id="importBtn">
          <i class="fas fa-file-import"></i> Import
        </button>
        <button class="export-btn" id="exportBtn">
          <i class="fas fa-file-export"></i> Export Data
        </button>
      </div>
    </header>

    <main class="player-section">
      <div class="video-wrapper">
        <div id="player"></div>
        <div class="video-overlay">
          <div class="video-info">
            <div class="video-title" id="videoTitle">Video Title</div>
            <div class="video-channel" id="videoChannel">Channel Name</div>
          </div>
        </div>
      </div>

      <div class="input-group">
        <input type="text" id="urlInput" class="url-input" placeholder="Paste YouTube URL, Video ID, or Playlist Link..." />
        <div class="input-actions">
          <button class="btn" id="loadBtn">
            <i class="fas fa-play"></i> Play
          </button>
          <button class="btn btn-sec" id="playlistBtn">
            <i class="fas fa-list"></i> Add to Playlist
          </button>
        </div>
      </div>

      <div class="now-playing-panel">
        <div class="panel-header">
          <h3><i class="fas fa-music"></i> Now Playing</h3>
          <div class="panel-actions">
            <button class="btn-icon" id="refreshInfoBtn" title="Refresh Video Info">
              <i class="fas fa-sync-alt"></i>
            </button>
            <button class="btn-icon" id="bookmarkBtn" title="Bookmark Video">
              <i class="fas fa-bookmark"></i>
            </button>
          </div>
        </div>
        
        <div id="statusDisplay" style="font-size: 1rem; color: var(--text-secondary); padding: 8px 0;">
          No video loaded. Paste a YouTube URL to begin.
        </div>
        
        <div class="video-stats">
          <div class="stat-item">
            <div class="stat-value" id="statDuration">0:00</div>
            <div class="stat-label">Duration</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="statProgress">0%</div>
            <div class="stat-label">Progress</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="statVolume">70%</div>
            <div class="stat-label">Volume</div>
          </div>
        </div>
        
        <div class="video-controls-quick">
          <button class="quick-control-btn" id="quickRewind">
            <i class="fas fa-backward"></i>
            <span class="quick-control-label">-10s</span>
          </button>
          <button class="quick-control-btn" id="quickForward">
            <i class="fas fa-forward"></i>
            <span class="quick-control-label">+10s</span>
          </button>
          <button class="quick-control-btn" id="quickSubtitles">
            <i class="fas fa-closed-captioning"></i>
            <span class="quick-control-label">CC</span>
          </button>
          <button class="quick-control-btn" id="quickQuality">
            <i class="fas fa-tachometer-alt"></i>
            <span class="quick-control-label">Quality</span>
          </button>
        </div>
      </div>
    </main>

    <aside class="sidebar">
      <div class="panel">
        <h3>
          <i class="fas fa-sliders-h"></i> Playback Settings
          <span class="panel-header-actions">
            <button class="btn btn-sec btn-small" onclick="resetDefaults()">Reset</button>
          </span>
        </h3>
        <div class="settings-grid">
          <div class="setting-item">
            <input type="checkbox" id="autoplay" checked />
            <label for="autoplay">Autoplay</label>
          </div>
          <div class="setting-item">
            <input type="checkbox" id="loop" />
            <label for="loop">Loop</label>
          </div>
          <div class="setting-item">
            <input type="checkbox" id="controls" checked />
            <label for="controls">Player Controls</label>
          </div>
          <div class="setting-item">
            <input type="checkbox" id="modest" />
            <label for="modest">Minimal UI</label>
          </div>
          <div class="setting-item">
            <input type="checkbox" id="annotations" />
            <label for="annotations">Annotations</label>
          </div>
          <div class="setting-item">
            <input type="checkbox" id="keyboardControls" checked />
            <label for="keyboardControls">Keyboard Controls</label>
          </div>
          <div class="setting-item full">
            <label for="startOverride">Start at (seconds)</label>
            <input type="number" id="startOverride" placeholder="e.g. 300" min="0" />
          </div>
          <div class="setting-item full">
            <label for="playbackRate">Playback Speed</label>
            <div class="range-with-value">
              <input type="range" id="playbackRate" min="0.25" max="2" step="0.25" value="1" />
              <span class="range-value" id="playbackRateValue">1x</span>
            </div>
          </div>
          <div class="setting-item full">
            <label for="volumeControl">Volume</label>
            <div class="range-with-value">
              <input type="range" id="volumeControl" min="0" max="100" value="70" />
              <span class="range-value" id="volumeValue">70%</span>
            </div>
          </div>
        </div>
        <button class="btn btn-sec" style="width: 100%; margin-top: 16px;" id="applyBtn">
          <i class="fas fa-redo"></i> Apply & Reload
        </button>
      </div>

      <div class="panel">
        <h3>
          <i class="fas fa-history"></i> Watch History
          <span class="panel-header-actions">
            <button class="btn btn-sec btn-small" onclick="wipeHistory()">Clear All</button>
            <button class="btn-icon" onclick="toggleHistoryView()" title="Change View">
              <i class="fas fa-th"></i>
            </button>
          </span>
        </h3>
        <ul class="history-list" id="historyList">
          <li style="padding:20px; text-align:center; color:var(--text-secondary);">
            <i class="fas fa-history fa-2x mb-4"></i>
            <div>No viewing history yet.</div>
          </li>
        </ul>
      </div>

      <div class="panel">
        <h3>
          <i class="fas fa-list-ol"></i> Playlist
          <span class="panel-header-actions">
            <button class="btn btn-sec btn-small" onclick="clearPlaylist()">Clear</button>
          </span>
        </h3>
        <div id="playlistContainer">
          <div style="padding:20px; text-align:center; color:var(--text-secondary);">
            <i class="fas fa-list fa-2x mb-4"></i>
            <div>Playlist is empty</div>
            <div class="mt-4">
              <button class="btn btn-sec btn-small" onclick="showPlaylistModal()">
                <i class="fas fa-plus"></i> Add Videos
              </button>
            </div>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <i class="fas fa-check-circle"></i>
    <span>Welcome to OmniPlayer Pro</span>
  </div>

  <!-- Playlist Modal -->
  <div class="modal" id="playlistModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Add to Playlist</div>
        <button class="modal-close" id="closePlaylistModal">&times;</button>
      </div>
      <div class="mb-4">
        <input type="text" id="playlistInput" class="url-input" placeholder="Enter YouTube URLs (one per line)..." style="width:100%; min-height:100px;" />
      </div>
      <div class="text-center">
        <button class="btn" id="addToPlaylistBtn">
          <i class="fas fa-plus"></i> Add Videos
        </button>
      </div>
    </div>
  </div>

  <!-- YouTube IFrame API -->
  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
    // ========== GLOBAL STATE & CONFIGURATION ==========
    const APP_NAME = 'OmniPlayer Pro';
    const APP_VERSION = '3.0';
    const STORAGE_KEYS = {
      HISTORY: 'yt_omni_pro_history_v3',
      SETTINGS: 'yt_omni_pro_settings_v3',
      PLAYLIST: 'yt_omni_pro_playlist_v3',
      BOOKMARKS: 'yt_omni_pro_bookmarks_v3',
      THEME: 'yt_omni_pro_theme'
    };

    let player;
    let saveInterval;
    let currentVideoInfo = {};
    let playlist = [];
    let currentPlaylistIndex = -1;
    
    const state = {
      videoId: '',
      history: {},
      bookmarks: {},
      settings: {
        autoplay: true,
        loop: false,
        controls: true,
        modest: false,
        annotations: true,
        keyboardControls: true,
        startTime: 0,
        playbackRate: 1,
        volume: 70,
        theme: 'light'
      }
    };

    // DOM Elements
    const els = {
      // Input & Controls
      input: document.getElementById('urlInput'),
      loadBtn: document.getElementById('loadBtn'),
      applyBtn: document.getElementById('applyBtn'),
      playlistBtn: document.getElementById('playlistBtn'),
      
      // Display Elements
      status: document.getElementById('statusDisplay'),
      historyList: document.getElementById('historyList'),
      playlistContainer: document.getElementById('playlistContainer'),
      videoTitle: document.getElementById('videoTitle'),
      videoChannel: document.getElementById('videoChannel'),
      
      // Stats Elements
      statDuration: document.getElementById('statDuration'),
      statProgress: document.getElementById('statProgress'),
      statVolume: document.getElementById('statVolume'),
      
      // Settings Elements
      autoplay: document.getElementById('autoplay'),
      loop: document.getElementById('loop'),
      controls: document.getElementById('controls'),
      modest: document.getElementById('modest'),
      annotations: document.getElementById('annotations'),
      keyboardControls: document.getElementById('keyboardControls'),
      startOverride: document.getElementById('startOverride'),
      playbackRate: document.getElementById('playbackRate'),
      playbackRateValue: document.getElementById('playbackRateValue'),
      volumeControl: document.getElementById('volumeControl'),
      volumeValue: document.getElementById('volumeValue'),
      
      // Quick Controls
      quickRewind: document.getElementById('quickRewind'),
      quickForward: document.getElementById('quickForward'),
      quickSubtitles: document.getElementById('quickSubtitles'),
      quickQuality: document.getElementById('quickQuality'),
      
      // Theme & UI
      themeBtn: document.getElementById('themeBtn'),
      themeDropdown: document.getElementById('themeDropdown'),
      exportBtn: document.getElementById('exportBtn'),
      importBtn: document.getElementById('importBtn'),
      refreshInfoBtn: document.getElementById('refreshInfoBtn'),
      bookmarkBtn: document.getElementById('bookmarkBtn'),
      
      // Modals
      playlistModal: document.getElementById('playlistModal'),
      closePlaylistModal: document.getElementById('closePlaylistModal'),
      playlistInput: document.getElementById('playlistInput'),
      addToPlaylistBtn: document.getElementById('addToPlaylistBtn'),
      
      // Toast
      toast: document.getElementById('toast')
    };

    // ========== ENHANCED TOAST SYSTEM ==========
    function showToast(message, type = 'info', duration = 3000) {
      const toast = els.toast;
      toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
        <span>${message}</span>
      `;
      toast.className = `toast ${type}`;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, duration);
    }

    // ========== THEME MANAGEMENT ==========
    function initTheme() {
      const savedTheme = localStorage.getItem(STORAGE_KEYS.THEME) || 'light';
      setTheme(savedTheme);
      
      // Set up theme dropdown
      els.themeBtn.addEventListener('click', () => {
        els.themeDropdown.classList.toggle('show');
      });
      
      document.querySelectorAll('.theme-option').forEach(option => {
        option.addEventListener('click', () => {
          const theme = option.dataset.theme;
          setTheme(theme);
          els.themeDropdown.classList.remove('show');
          
          // Update active state
          document.querySelectorAll('.theme-option').forEach(o => o.classList.remove('active'));
          option.classList.add('active');
        });
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!els.themeBtn.contains(e.target) && !els.themeDropdown.contains(e.target)) {
          els.themeDropdown.classList.remove('show');
        }
      });
    }

    function setTheme(theme) {
      document.body.setAttribute('data-theme', theme);
      state.settings.theme = theme;
      localStorage.setItem(STORAGE_KEYS.THEME, theme);
      
      const themeNames = { light: 'Light', dark: 'Dark', midnight: 'Midnight' };
      showToast(`Switched to ${themeNames[theme]} Theme`, 'info');
    }

    // ========== YOUTUBE PLAYER INTEGRATION ==========
    function onYouTubeIframeAPIReady() {
      showToast('YouTube Player API Loaded ‚úÖ', 'success');
      loadInitialSettings();
    }

    function loadVideo(videoId = null, startTime = null, fromPlaylist = false) {
      let inputVal = els.input.value.trim();
      let targetVideoId = videoId || extractVideoId(inputVal);
      
      if (!targetVideoId) {
        showToast('‚ö†Ô∏è Invalid YouTube URL or ID', 'error');
        return;
      }

      currentVideoInfo = {
        id: targetVideoId,
        title: 'Loading...',
        channel: 'Unknown',
        duration: 0
      };

      state.videoId = targetVideoId;
      
      // Determine start time
      let actualStartTime = startTime !== null ? startTime : 
                           els.startOverride.value ? parseInt(els.startOverride.value) || 0 :
                           (state.history[targetVideoId] && state.history[targetVideoId].time > 5) ? 
                           Math.floor(state.history[targetVideoId].time) : 0;

      // Update status message
      let statusMsg = '';
      if (actualStartTime > 0) {
        statusMsg = `‚ñ∂ Resuming from ${formatTime(actualStartTime)}`;
      } else {
        statusMsg = '‚ñ∂ Starting from beginning';
      }
      
      if (fromPlaylist && playlist.length > 0) {
        statusMsg += ` (${currentPlaylistIndex + 1}/${playlist.length})`;
      }
      
      els.status.innerHTML = `<strong>${statusMsg}</strong>`;

      // Destroy existing player
      if (player) {
        player.destroy();
        clearInterval(saveInterval);
      }

      // Configure player variables
      const playerVars = {
        playsinline: 1,
        controls: els.controls.checked ? 1 : 0,
        rel: 0,
        fs: 1,
        modestbranding: els.modest.checked ? 1 : 0,
        start: actualStartTime,
        iv_load_policy: els.annotations.checked ? 1 : 3,
        enablejsapi: 1
      };

      if (els.loop.checked) {
        playerVars.playlist = targetVideoId;
        playerVars.loop = 1;
      }

      // Create new player
      player = new YT.Player('player', {
        videoId: targetVideoId,
        playerVars: playerVars,
        events: {
          onReady: onPlayerReady,
          onStateChange: onPlayerStateChange,
          onError: (e) => {
            showToast(`‚ùå Video Error: ${getErrorMessage(e.data)}`, 'error');
          },
          onPlaybackQualityChange: (e) => {
            showToast(`Quality changed to: ${e.data}`, 'info', 2000);
          }
        }
      });

      // Update history and input field
      updateHistoryEntry(targetVideoId, actualStartTime);
      els.input.value = `https://youtu.be/${targetVideoId}`;
      
      // Try to fetch video info
      fetchVideoInfo(targetVideoId);
    }

    function getErrorMessage(errorCode) {
      const errors = {
        2: 'Invalid video ID',
        5: 'HTML5 player error',
        100: 'Video not found',
        101: 'Embedding not allowed',
        150: 'Embedding not allowed'
      };
      return errors[errorCode] || `Error code: ${errorCode}`;
    }

    function onPlayerReady(event) {
      // Apply stored settings
      player.setPlaybackRate(state.settings.playbackRate);
      player.setVolume(state.settings.volume);
      
      if (els.autoplay.checked) {
        event.target.playVideo();
      }
      
      startSavingProgress();
      updateVideoStats();
      setupKeyboardControls();
      
      showToast('Player ready!', 'success', 2000);
    }

    function onPlayerStateChange(event) {
      if (event.data === YT.PlayerState.PLAYING) {
        startSavingProgress();
        updateVideoStats();
      } else if (event.data === YT.PlayerState.PAUSED) {
        clearInterval(saveInterval);
      } else if (event.data === YT.PlayerState.ENDED) {
        clearInterval(saveInterval);
        
        // Auto-play next video in playlist
        if (playlist.length > 0 && currentPlaylistIndex >= 0) {
          setTimeout(() => playNextInPlaylist(), 2000);
        }
      }
    }

    // ========== VIDEO INFO FETCHING ==========
    async function fetchVideoInfo(videoId) {
      try {
        // This is a placeholder - in a real app, you'd use the YouTube Data API
        // For demo purposes, we'll simulate fetching
        setTimeout(() => {
          currentVideoInfo = {
            id: videoId,
            title: `Video ${videoId.substring(0, 8)}...`,
            channel: 'YouTube Channel',
            duration: 300, // 5 minutes for demo
            views: '1.5M',
            likes: '50K'
          };
          
          updateVideoDisplay();
        }, 500);
        
      } catch (error) {
        console.warn('Could not fetch video info:', error);
      }
    }

    function updateVideoDisplay() {
      els.videoTitle.textContent = currentVideoInfo.title;
      els.videoChannel.textContent = currentVideoInfo.channel;
      els.statDuration.textContent = formatTime(currentVideoInfo.duration);
    }

    // ========== PROGRESS SAVING & HISTORY ==========
    function startSavingProgress() {
      clearInterval(saveInterval);
      saveInterval = setInterval(() => {
        if (player && player.getCurrentTime) {
          const time = player.getCurrentTime();
          const duration = player.getDuration();
          
          if (time > 0 && duration > 0) {
            saveToHistory(state.videoId, time, duration);
            updateVideoStats();
          }
        }
      }, 3000); // More frequent updates for smoother progress bars
    }

    function saveToHistory(id, time, duration) {
      if (!state.history[id]) state.history[id] = {};
      
      state.history[id] = {
        id,
        time,
        duration,
        lastPlayed: Date.now(),
        title: currentVideoInfo.title || `Video ${id.substring(0, 8)}...`,
        thumbnail: `https://img.youtube.com/vi/${id}/mqdefault.jpg`
      };
      
      localStorage.setItem(STORAGE_KEYS.HISTORY, JSON.stringify(state.history));
      renderHistory();
    }

    function updateVideoStats() {
      if (!player) return;
      
      const currentTime = player.getCurrentTime();
      const duration = player.getDuration();
      const volume = player.getVolume();
      
      if (duration > 0) {
        const progressPercent = Math.round((currentTime / duration) * 100);
        els.statProgress.textContent = `${progressPercent}%`;
      }
      
      els.statVolume.textContent = `${volume}%`;
    }

    // ========== ENHANCED HISTORY RENDERING ==========
    function renderHistory() {
      const list = els.historyList;
      const history = state.history;

      if (!Object.keys(history).length) {
        list.innerHTML = `
          <li style="padding:20px; text-align:center; color:var(--text-secondary);">
            <i class="fas fa-history fa-2x mb-4"></i>
            <div>No viewing history yet.</div>
          </li>`;
        return;
      }

      const sorted = Object.values(history).sort((a, b) => b.lastPlayed - a.lastPlayed);
      list.innerHTML = '';

      sorted.forEach(item => {
        const percent = item.duration ? Math.min(100, (item.time / item.duration) * 100) : 0;
        const isCurrent = item.id === state.videoId;
        const timeAgo = getTimeAgo(item.lastPlayed);
        
        const li = document.createElement('li');
        li.className = `history-item ${isCurrent ? 'watching-now' : ''}`;
        li.onclick = () => loadVideo(item.id);
        
        li.innerHTML = `
          <img src="${item.thumbnail}" class="history-thumb" loading="lazy" 
               onerror="this.src='https://placehold.co/100x75/333/999?text=No+Preview'">
          <div class="history-info">
            <div class="history-title">${item.title || `ID: ${item.id}`}</div>
            <div class="history-meta">
              <span>${formatTime(item.time)} / ${formatTime(item.duration || 0)}</span>
              <span>${timeAgo}</span>
            </div>
            <div class="history-progress-bg">
              <div class="history-progress-fill" style="width: ${percent.toFixed(2)}%"></div>
            </div>
          </div>
          <div class="history-actions">
            <div class="btn-icon" onclick="deleteHistory(event, '${item.id}')" title="Delete">
              <i class="fas fa-trash"></i>
            </div>
            <div class="btn-icon" onclick="bookmarkVideo('${item.id}')" title="Bookmark">
              <i class="fas fa-bookmark"></i>
            </div>
          </div>
        `;
        list.appendChild(li);
      });
    }

    function getTimeAgo(timestamp) {
      const seconds = Math.floor((Date.now() - timestamp) / 1000);
      
      if (seconds < 60) return 'Just now';
      if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
      if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
      if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
      return new Date(timestamp).toLocaleDateString();
    }

    // ========== PLAYBACK CONTROLS ==========
    function setupKeyboardControls() {
      if (!els.keyboardControls.checked) return;
      
      document.addEventListener('keydown', (e) => {
        if (!player || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        
        switch(e.key) {
          case ' ':
          case 'k':
            togglePlayPause();
            e.preventDefault();
            break;
          case 'f':
            toggleFullscreen();
            e.preventDefault();
            break;
          case 'm':
            toggleMute();
            e.preventDefault();
            break;
          case 'ArrowLeft':
            seekRelative(-10);
            e.preventDefault();
            break;
          case 'ArrowRight':
            seekRelative(10);
            e.preventDefault();
            break;
          case 'j':
            seekRelative(-10);
            e.preventDefault();
            break;
          case 'l':
            seekRelative(10);
            e.preventDefault();
            break;
          case 'c':
            toggleCaptions();
            e.preventDefault();
            break;
          case '>':
          case '.':
            player.nextVideo?.();
            e.preventDefault();
            break;
          case '<':
          case ',':
            player.previousVideo?.();
            e.preventDefault();
            break;
        }
      });
    }

    function togglePlayPause() {
      if (!player) return;
      
      if (player.getPlayerState() === YT.PlayerState.PLAYING) {
        player.pauseVideo();
        showToast('‚è∏Ô∏è Paused', 'info', 1000);
      } else {
        player.playVideo();
        showToast('‚ñ∂Ô∏è Playing', 'info', 1000);
      }
    }

    function toggleFullscreen() {
      const playerElement = document.getElementById('player');
      if (!document.fullscreenElement) {
        playerElement.requestFullscreen?.();
      } else {
        document.exitFullscreen?.();
      }
    }

    function toggleMute() {
      if (!player) return;
      
      if (player.isMuted()) {
        player.unMute();
        showToast('üîä Unmuted', 'info', 1000);
      } else {
        player.mute();
        showToast('üîá Muted', 'info', 1000);
      }
    }

    function seekRelative(seconds) {
      if (!player) return;
      
      const currentTime = player.getCurrentTime();
      const newTime = Math.max(0, currentTime + seconds);
      player.seekTo(newTime, true);
      
      showToast(`${seconds > 0 ? '‚è©' : '‚è™'} ${Math.abs(seconds)}s`, 'info', 1000);
    }

    function toggleCaptions() {
      // Caption toggling would require additional API integration
      showToast('Closed captions toggled', 'info', 1000);
    }

    // ========== PLAYLIST MANAGEMENT ==========
    function initPlaylist() {
      const savedPlaylist = localStorage.getItem(STORAGE_KEYS.PLAYLIST);
      if (savedPlaylist) {
        try {
          playlist = JSON.parse(savedPlaylist);
          renderPlaylist();
        } catch (e) {
          console.warn('Failed to parse playlist');
        }
      }
    }

    function renderPlaylist() {
      const container = els.playlistContainer;
      
      if (!playlist.length) {
        container.innerHTML = `
          <div style="padding:20px; text-align:center; color:var(--text-secondary);">
            <i class="fas fa-list fa-2x mb-4"></i>
            <div>Playlist is empty</div>
            <div class="mt-4">
              <button class="btn btn-sec btn-small" onclick="showPlaylistModal()">
                <i class="fas fa-plus"></i> Add Videos
              </button>
            </div>
          </div>`;
        return;
      }
      
      container.innerHTML = '<div id="playlistItems"></div>';
      const itemsContainer = document.getElementById('playlistItems');
      
      playlist.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = `playlist-item ${index === currentPlaylistIndex ? 'active' : ''}`;
        div.innerHTML = `
          <div class="drag-handle">
            <i class="fas fa-grip-vertical"></i>
          </div>
          <div style="flex:1; font-size:0.9rem; font-weight:${index === currentPlaylistIndex ? '700' : '500'};">
            ${item.title || `Video ${item.id.substring(0, 8)}...`}
          </div>
          <div class="history-actions">
            <div class="btn-icon" onclick="playFromPlaylist(${index})" title="Play">
              <i class="fas fa-play"></i>
            </div>
            <div class="btn-icon" onclick="removeFromPlaylist(${index})" title="Remove">
              <i class="fas fa-times"></i>
            </div>
          </div>
        `;
        itemsContainer.appendChild(div);
      });
      
      // Add drag and drop functionality
      makePlaylistSortable();
    }

    function showPlaylistModal() {
      els.playlistModal.classList.add('show');
    }

    function hidePlaylistModal() {
      els.playlistModal.classList.remove('show');
    }

    function addToPlaylist() {
      const input = els.playlistInput.value.trim();
      if (!input) {
        showToast('Please enter at least one video URL', 'warning');
        return;
      }
      
      const urls = input.split('\n').filter(url => url.trim());
      let addedCount = 0;
      
      urls.forEach(url => {
        const videoId = extractVideoId(url.trim());
        if (videoId && !playlist.find(item => item.id === videoId)) {
          playlist.push({
            id: videoId,
            title: `Video ${videoId.substring(0, 8)}...`,
            added: Date.now()
          });
          addedCount++;
        }
      });
      
      localStorage.setItem(STORAGE_KEYS.PLAYLIST, JSON.stringify(playlist));
      renderPlaylist();
      hidePlaylistModal();
      els.playlistInput.value = '';
      
      showToast(`Added ${addedCount} video${addedCount !== 1 ? 's' : ''} to playlist`, 'success');
    }

    function playFromPlaylist(index) {
      if (index < 0 || index >= playlist.length) return;
      
      currentPlaylistIndex = index;
      const video = playlist[index];
      loadVideo(video.id, 0, true);
      renderPlaylist();
    }

    function playNextInPlaylist() {
      if (playlist.length === 0) return;
      
      currentPlaylistIndex = (currentPlaylistIndex + 1) % playlist.length;
      playFromPlaylist(currentPlaylistIndex);
    }

    function removeFromPlaylist(index) {
      playlist.splice(index, 1);
      
      if (currentPlaylistIndex >= index) {
        currentPlaylistIndex--;
      }
      
      localStorage.setItem(STORAGE_KEYS.PLAYLIST, JSON.stringify(playlist));
      renderPlaylist();
      showToast('Removed from playlist', 'info');
    }

    function clearPlaylist() {
      if (!playlist.length) return;
      
      if (confirm('Clear entire playlist?')) {
        playlist = [];
        currentPlaylistIndex = -1;
        localStorage.setItem(STORAGE_KEYS.PLAYLIST, JSON.stringify(playlist));
        renderPlaylist();
        showToast('Playlist cleared', 'success');
      }
    }

    function makePlaylistSortable() {
      // Simplified drag and drop - in a full implementation, you'd use a library like SortableJS
      const items = document.querySelectorAll('.playlist-item');
      items.forEach(item => {
        item.setAttribute('draggable', 'true');
        
        item.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('text/plain', Array.from(items).indexOf(item));
        });
        
        item.addEventListener('dragover', (e) => {
          e.preventDefault();
        });
        
        item.addEventListener('drop', (e) => {
          e.preventDefault();
          const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
          const toIndex = Array.from(items).indexOf(item);
          
          if (fromIndex !== toIndex) {
            // Move item in playlist array
            const [movedItem] = playlist.splice(fromIndex, 1);
            playlist.splice(toIndex, 0, movedItem);
            
            // Update current index if needed
            if (currentPlaylistIndex === fromIndex) {
              currentPlaylistIndex = toIndex;
            } else if (currentPlaylistIndex > fromIndex && currentPlaylistIndex <= toIndex) {
              currentPlaylistIndex--;
            } else if (currentPlaylistIndex < fromIndex && currentPlaylistIndex >= toIndex) {
              currentPlaylistIndex++;
            }
            
            localStorage.setItem(STORAGE_KEYS.PLAYLIST, JSON.stringify(playlist));
            renderPlaylist();
            showToast('Playlist reordered', 'info');
          }
        });
      });
    }

    // ========== BOOKMARKS ==========
    function bookmarkVideo(videoId) {
      if (!state.bookmarks[videoId]) {
        state.bookmarks[videoId] = {
          id: videoId,
          title: state.history[videoId]?.title || `Video ${videoId.substring(0, 8)}...`,
          time: state.history[videoId]?.time || 0,
          added: Date.now()
        };
        showToast('‚úÖ Video bookmarked', 'success');
      } else {
        delete state.bookmarks[videoId];
        showToast('üóëÔ∏è Bookmark removed', 'info');
      }
      
      localStorage.setItem(STORAGE_KEYS.BOOKMARKS, JSON.stringify(state.bookmarks));
    }

    // ========== DATA IMPORT/EXPORT ==========
    function exportData() {
      const exportData = {
        app: APP_NAME,
        version: APP_VERSION,
        exported: Date.now(),
        history: state.history,
        bookmarks: state.bookmarks,
        playlist: playlist,
        settings: state.settings
      };
      
      const dataStr = JSON.stringify(exportData, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      
      const exportFileDefaultName = `omniplayer-pro-backup-${new Date().toISOString().split('T')[0]}.json`;
      
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();
      
      showToast('‚úÖ Data exported successfully', 'success');
    }

    function importData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'application/json';
      
      input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        
        reader.onload = (event) => {
          try {
            const importedData = JSON.parse(event.target.result);
            
            if (importedData.app !== APP_NAME) {
              showToast('‚ö†Ô∏è Invalid backup file', 'error');
              return;
            }
            
            // Import data with confirmation
            if (confirm('Import history, bookmarks, playlist, and settings?')) {
              if (importedData.history) state.history = importedData.history;
              if (importedData.bookmarks) state.bookmarks = importedData.bookmarks;
              if (importedData.playlist) playlist = importedData.playlist;
              if (importedData.settings) {
                Object.assign(state.settings, importedData.settings);
                applySettingsToUI();
              }
              
              // Save to localStorage
              localStorage.setItem(STORAGE_KEYS.HISTORY, JSON.stringify(state.history));
              localStorage.setItem(STORAGE_KEYS.BOOKMARKS, JSON.stringify(state.bookmarks));
              localStorage.setItem(STORAGE_KEYS.PLAYLIST, JSON.stringify(playlist));
              localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(state.settings));
              
              // Update UI
              renderHistory();
              renderPlaylist();
              showToast('‚úÖ Data imported successfully', 'success');
            }
          } catch (error) {
            showToast('‚ùå Failed to import data', 'error');
            console.error('Import error:', error);
          }
        };
        
        reader.readAsText(file);
      };
      
      input.click();
    }

    // ========== SETTINGS MANAGEMENT ==========
    function loadInitialSettings() {
      const savedSettings = localStorage.getItem(STORAGE_KEYS.SETTINGS);
      if (savedSettings) {
        try {
          const parsed = JSON.parse(savedSettings);
          Object.assign(state.settings, parsed);
        } catch (e) {
          console.warn('Failed to parse settings');
        }
      }
      
      applySettingsToUI();
      renderHistory();
      initPlaylist();
      initTheme();
    }

    function applySettingsToUI() {
      // Apply settings to checkboxes
      els.autoplay.checked = state.settings.autoplay;
      els.loop.checked = state.settings.loop;
      els.controls.checked = state.settings.controls;
      els.modest.checked = state.settings.modest;
      els.annotations.checked = state.settings.annotations;
      els.keyboardControls.checked = state.settings.keyboardControls;
      
      // Apply settings to ranges
      els.playbackRate.value = state.settings.playbackRate;
      els.playbackRateValue.textContent = `${state.settings.playbackRate}x`;
      els.volumeControl.value = state.settings.volume;
      els.volumeValue.textContent = `${state.settings.volume}%`;
    }

    function saveSettings() {
      // Update state from UI
      state.settings.autoplay = els.autoplay.checked;
      state.settings.loop = els.loop.checked;
      state.settings.controls = els.controls.checked;
      state.settings.modest = els.modest.checked;
      state.settings.annotations = els.annotations.checked;
      state.settings.keyboardControls = els.keyboardControls.checked;
      state.settings.playbackRate = parseFloat(els.playbackRate.value);
      state.settings.volume = parseInt(els.volumeControl.value);
      
      localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(state.settings));
    }

    function resetDefaults() {
      if (confirm('Reset all settings to default values?')) {
        state.settings = {
          autoplay: true,
          loop: false,
          controls: true,
          modest: false,
          annotations: true,
          keyboardControls: true,
          startTime: 0,
          playbackRate: 1,
          volume: 70,
          theme: 'light'
        };
        
        applySettingsToUI();
        saveSettings();
        showToast('Settings reset to defaults', 'success');
      }
    }

    // ========== UTILITY FUNCTIONS ==========
    function extractVideoId(url) {
      if (!url) return null;
      
      // Handle playlist URLs
      if (url.includes('list=')) {
        const listMatch = url.match(/[?&]list=([^&]+)/);
        if (listMatch) {
          showToast('Playlist URLs are not fully supported yet', 'warning');
        }
      }
      
      const match = url.match(/(?:youtu\.be\/|v\/|embed\/|watch\?v=|&v=)([^&#]{11})/);
      return match ? match[1] : (url.length === 11 ? url : null);
    }

    function formatTime(seconds) {
      if (isNaN(seconds) || seconds <= 0) return '0:00';
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = Math.floor(seconds % 60);
      if (h > 0) return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
      return `${m}:${s.toString().padStart(2, '0')}`;
    }

    function updateHistoryEntry(id, time) {
      saveToHistory(id, time, 0);
    }

    function deleteHistory(e, id) {
      e.stopPropagation();
      delete state.history[id];
      localStorage.setItem(STORAGE_KEYS.HISTORY, JSON.stringify(state.history));
      renderHistory();
      showToast('History entry removed', 'info');
    }

    function wipeHistory() {
      if (confirm('üóëÔ∏è Clear ALL watch history? This cannot be undone.')) {
        state.history = {};
        localStorage.removeItem(STORAGE_KEYS.HISTORY);
        renderHistory();
        showToast('All history cleared', 'success');
      }
    }

    function toggleHistoryView() {
      // Toggle between list and grid view
      showToast('View toggle coming soon!', 'info');
    }

    // ========== EVENT LISTENERS ==========
    function setupEventListeners() {
      // Video loading
      els.loadBtn.addEventListener('click', () => loadVideo());
      els.applyBtn.addEventListener('click', () => {
        if (state.videoId) {
          saveSettings();
          loadVideo(state.videoId);
        } else {
          showToast('‚ö†Ô∏è No video is currently loaded', 'warning');
        }
      });
      els.input.addEventListener('keypress', e => e.key === 'Enter' && loadVideo());
      
      // Quick controls
      els.quickRewind.addEventListener('click', () => seekRelative(-10));
      els.quickForward.addEventListener('click', () => seekRelative(10));
      els.quickSubtitles.addEventListener('click', toggleCaptions);
      els.quickQuality.addEventListener('click', () => {
        if (player) {
          const qualities = player.getAvailableQualityLevels?.();
          if (qualities && qualities.length > 0) {
            showToast(`Available qualities: ${qualities.join(', ')}`, 'info');
          }
        }
      });
      
      // Playlist
      els.playlistBtn.addEventListener('click', () => {
        const videoId = extractVideoId(els.input.value);
        if (videoId) {
          if (!playlist.find(item => item.id === videoId)) {
            playlist.push({
              id: videoId,
              title: `Video ${videoId.substring(0, 8)}...`,
              added: Date.now()
            });
            localStorage.setItem(STORAGE_KEYS.PLAYLIST, JSON.stringify(playlist));
            renderPlaylist();
            showToast('Added to playlist', 'success');
          } else {
            showToast('Video already in playlist', 'info');
          }
        } else {
          showPlaylistModal();
        }
      });
      
      // Settings changes
      els.playbackRate.addEventListener('input', (e) => {
        els.playbackRateValue.textContent = `${e.target.value}x`;
        if (player) player.setPlaybackRate(parseFloat(e.target.value));
      });
      
      els.volumeControl.addEventListener('input', (e) => {
        els.volumeValue.textContent = `${e.target.value}%`;
        if (player) player.setVolume(parseInt(e.target.value));
      });
      
      // Data management
      els.exportBtn.addEventListener('click', exportData);
      els.importBtn.addEventListener('click', importData);
      
      // Refresh video info
      els.refreshInfoBtn.addEventListener('click', () => {
        if (state.videoId) {
          fetchVideoInfo(state.videoId);
          showToast('Refreshing video info...', 'info');
        }
      });
      
      // Bookmark current video
      els.bookmarkBtn.addEventListener('click', () => {
        if (state.videoId) {
          bookmarkVideo(state.videoId);
        }
      });
      
      // Modal controls
      els.closePlaylistModal.addEventListener('click', hidePlaylistModal);
      els.addToPlaylistBtn.addEventListener('click', addToPlaylist);
      
      // Close modal when clicking outside
      els.playlistModal.addEventListener('click', (e) => {
        if (e.target === els.playlistModal) {
          hidePlaylistModal();
        }
      });
    }

    // ========== INITIALIZATION ==========
    document.addEventListener('DOMContentLoaded', () => {
      setupEventListeners();
      loadInitialSettings();
      showToast('Welcome to OmniPlayer Pro v3.0! üé¨', 'success', 4000);
    });
  </script>
</body>
</html>
